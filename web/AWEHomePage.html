<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Educator Dashboard</title>
    <script src="scripts/dashboard-loader.js"></script>
    <script src="scripts/tailwindcss3_4.js"></script>
    <script src="scripts/attendance-marker.js"></script>
    <script src="scripts/enrollments.js"></script>
<script src="scripts/evals.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }

        .card-hover {
            -webkit-transition: all 0.3s ease;
            -moz-transition: all 0.3s ease;
            -o-transition: all 0.3s ease;
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            -webkit-transform: translateY(-2px);
            -moz-transform: translateY(-2px);
            -ms-transform: translateY(-2px);
            -o-transform: translateY(-2px);
            transform: translateY(-2px);
            -webkit-box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            -moz-box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .gradient-bg {
            background: #667eea; /* Fallback for older browsers */
            background: -webkit-linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background: -moz-linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background: -o-linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .pulse-dot {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .voice-input-container {
            position: relative;
        }

        .voice-button {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 6px;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 10;
        }

        .voice-button:hover {
            background: #e5e7eb;
        }

        .voice-button.recording {
            background: #ef4444;
            color: white;
            animation: pulse-red 1.5s infinite;
        }

        .voice-button.processing {
            background: #3b82f6;
            color: white;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .voice-status {
            position: absolute;
            top: -25px;
            right: 0;
            background: #1f2937;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 20;
        }

        .voice-status::after {
            content: '';
            position: absolute;
            top: 100%;
            right: 10px;
            border: 4px solid transparent;
            border-top-color: #1f2937;
        }
    </style>
    <style>@view-transition { navigation: auto; }</style>
</head>
<body class="min-h-full bg-gray-50"><!-- Header -->
<header class="gradient-bg text-white py-6 px-4 shadow-lg">
    <div class="max-w-6xl mx-auto">
        <div class="flex items-center justify-between">
            <div>
                <h1 id="school-name" class="text-2xl md:text-3xl font-bold">Anganwadi - Alwala</h1>
                <p id="educator-name" class="text-blue-100">Devaki</p>
            </div>
            <div class="text-right">
                <div class="text-sm opacity-90" id="current-date"></div>
                <div class="text-lg font-semibold" id="current-time"></div>
            </div>
        </div>
        <p id="welcome-message" class="mt-4 text-blue-100">Welcome back! Ready for another great day?</p>
    </div>
</header><!-- Main Dashboard -->
<main class="max-w-6xl mx-auto px-4 py-8"><!-- Quick Stats -->
    <section class="mb-8">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white rounded-lg p-4 shadow-md text-center">
                <div class="text-2xl font-bold text-blue-600" id="total-students">
                    0
                </div>
                <div class="text-sm text-gray-600">
                    Total Students
                </div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-md text-center">
                <div class="text-2xl font-bold text-green-600" id="present-today">
                    0
                </div>
                <div class="text-sm text-gray-600">
                    Present Today
                </div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-md text-center">
                <div class="text-2xl font-bold text-orange-600" id="home-visits-today">
                    0
                </div>
                <div class="text-sm text-gray-600">
                    Home Visits Today
                </div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-md text-center">
                <div class="text-2xl font-bold text-purple-600" id="activities-logged">
                    0
                </div>
                <div class="text-sm text-gray-600">
                    Activities done today
                </div>
            </div>
        </div>
    </section><!-- Quick Views -->
    <section class="mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Quick Views</h2>
        <div class="grid md:grid-cols-3 gap-6 mb-8"><!-- Student List View -->
            <div class="bg-white rounded-xl p-6 shadow-lg card-hover cursor-pointer" onclick="openModal('student-list')">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <div class="bg-blue-100 p-3 rounded-full mr-4"><span class="text-2xl">üë®‚Äçüéì</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">Student List</h3>
                            <p class="text-gray-600">View all enrolled students</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-blue-600" id="enrolled-count">
                            0
                        </div>
                        <div class="text-sm text-gray-500">
                            Enrolled
                        </div>
                    </div>
                </div>
                <div class="text-sm text-blue-600 font-medium">
                    Click to view ‚Üí
                </div>
            </div><!-- Program List View -->
            <div class="bg-white rounded-xl p-6 shadow-lg card-hover cursor-pointer" onclick="openModal('program-list')">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <div class="bg-green-100 p-3 rounded-full mr-4"><span class="text-2xl">üìö</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">Program List</h3>
                            <p class="text-gray-600">View all programs</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-green-600">
                            4
                        </div>
                        <div class="text-sm text-gray-500">
                            Programs
                        </div>
                    </div>
                </div>
                <div class="text-sm text-green-600 font-medium">
                    Click to view ‚Üí
                </div>
            </div><!-- Plan of the day -->
            <div class="bg-white rounded-xl p-6 shadow-lg card-hover cursor-pointer" onclick="openModal('plan')">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <div class="bg-teal-100 p-3 rounded-full mr-4"><span class="text-2xl">‚ú®</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">Plan of the day</h3>
                            <p class="text-gray-600">View plan of the day</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold text-teal-600" id="todo-count">
                            4
                        </div>
                        <div class="text-sm text-gray-500">
                            Activities
                        </div>
                    </div>
                </div>
                <div class="text-sm text-teal-600 font-medium">
                    Click to view ‚Üí
                </div>
            </div>
        </div>
    </section><!-- Operation Cards -->
    <section class="mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Operations</h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"><!-- Enrollment -->
            <div class="bg-white rounded-xl p-6 shadow-lg card-hover cursor-pointer" onclick="openModal('enrollment')">
                <div class="flex items-center mb-4">
                    <div class="bg-blue-100 p-3 rounded-full mr-4"><span class="text-2xl">üìù</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Enrollment</h3>
                        <p class="text-gray-600">Manage student enrollment</p>
                    </div>
                </div>
                <div class="text-sm text-blue-600 font-medium">
                    Click to manage ‚Üí
                </div>
            </div><!-- Attendance -->
            <div class="bg-white rounded-xl p-6 shadow-lg card-hover cursor-pointer" onclick="openModal('attendance')">
                <div class="flex items-center mb-4">
                    <div class="bg-green-100 p-3 rounded-full mr-4"><span class="text-2xl">‚úÖ</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Attendance</h3>
                        <p class="text-gray-600">Track daily attendance with time</p>
                    </div>
                </div>
                <div class="text-sm text-green-600 font-medium">
                    Click to track ‚Üí
                </div>
            </div><!-- Activity Logs -->
            <div class="bg-white rounded-xl p-6 shadow-lg card-hover cursor-pointer" onclick="openModal('activities')">
                <div class="flex items-center mb-4">
                    <div class="bg-indigo-100 p-3 rounded-full mr-4"><span class="text-2xl">üéØ</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Activity Logs</h3>
                        <p class="text-gray-600">Log student activities</p>
                    </div>
                </div>
                <div class="text-sm text-indigo-600 font-medium">
                    Click to log ‚Üí
                </div>
            </div>

            <!-- Home Visits -->
            <div class="bg-white rounded-xl p-6 shadow-lg card-hover cursor-pointer" onclick="openModal('visits')">
                <div class="flex items-center mb-4">
                    <div class="bg-red-100 p-3 rounded-full mr-4"><span class="text-2xl">üè†</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Home Visits</h3>
                        <p class="text-gray-600">Plan &amp; track home visits</p>
                    </div>
                </div>
                <div class="text-sm text-red-600 font-medium">
                    Click to track ‚Üí
                </div>
            </div><!-- End of the day review -->
            <div class="bg-white rounded-xl p-6 shadow-lg card-hover cursor-pointer" onclick="openModal('review')">
                <div class="flex items-center mb-4">
                    <div class="bg-teal-100 p-3 rounded-full mr-4"><span class="text-2xl">üìñ</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">End of the day Review</h3>
                        <p class="text-gray-600">Review today's work</p>
                    </div>
                </div>
                <div class="text-sm text-teal-600 font-medium">
                    Click to review ‚Üí
                </div>
            </div><!-- Objective Evaluations -->
            <div class="bg-white rounded-xl p-6 shadow-lg card-hover cursor-pointer" onclick="openModal('evaluations')">
                <div class="flex items-center mb-4">
                    <div class="bg-orange-100 p-3 rounded-full mr-4"><span class="text-2xl">üìä</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Evaluations</h3>
                        <p class="text-gray-600">Daily progress assessments</p>
                    </div>
                </div>
                <div class="text-sm text-orange-600 font-medium">
                    Click to evaluate ‚Üí
                </div>
            </div><!-- Attendance Reports -->
            <div class="bg-white rounded-xl p-6 shadow-lg card-hover cursor-pointer" onclick="openModal('attendance-reports')">
                <div class="flex items-center mb-4">
                    <div class="bg-cyan-100 p-3 rounded-full mr-4"><span class="text-2xl">üìà</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-800">Attendance Reports</h3>
                        <p class="text-gray-600">View student &amp; class reports</p>
                    </div>
                </div>
                <div class="text-sm text-cyan-600 font-medium">
                    Click to view ‚Üí
                </div>
            </div>
        </div>
    </section><!-- Recent Activities -->
    <section>
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Recent Activities</h2>
        <div class="bg-white rounded-xl shadow-lg">
            <div id="activities-list" class="divide-y divide-gray-200">
                <div class="p-4 text-center text-gray-500">
                    No activities recorded yet. Start by using the operation cards above!
                </div>
            </div>
        </div>
    </section>
</main><!-- Modals --> <!-- Enrollment Modal -->
<div id="enrollment-modal" class="modal">
    <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-bold mb-4">New Student Enrollment</h3>
        <form id="enrollment-form"><!-- Student Information -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-800 mb-3">Student Information</h4>
                <div class="grid md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">First Name</label> <input type="text" id="student-first-name" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Last Name</label> <input type="text" id="student-last-name" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Date of Birth</label> <input type="date" id="student-dob" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Date of Joining</label> <input type="date" id="student-doj" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Gender</label> <select id="student-gender" class="w-full p-3 border border-gray-300 rounded-lg" required> <option value="">Select gender</option> <option value="male">Male</option> <option value="female">Female</option> <option value="other">Other</option> </select>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Social Category</label> <select id="student-social-category" class="w-full p-3 border border-gray-300 rounded-lg" required> <option value="">Select category</option> <option value="SC">SC (Scheduled Caste)</option> <option value="ST">ST (Scheduled Tribe)</option> <option value="BC">BC (Backward Class)</option> <option value="General">General</option> </select>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Contact Number</label> <input type="tel" id="student-contact" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                </div>
                <div class="mt-4"><label class="block text-sm font-medium text-gray-700 mb-2">Address</label> <textarea id="student-address" class="w-full p-3 border border-gray-300 rounded-lg" rows="2" required></textarea>
                </div>
            <!-- Parent/Guardian Information -->

             <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-lg font-semibold text-gray-800">Parent/Guardian Information</h4>
                    </div>
                    <div id="parents-container">
                        <div class="parent-entry bg-gray-50 rounded-lg p-4 mb-4" data-parent-index="0">
                            <div class="flex justify-between items-center mb-3">
                                <h5 class="font-medium text-gray-700">Primary Parent</h5>
                            </div>
                            <div class="grid md:grid-cols-3 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700 mb-2">Full Name <span class="text-red-500">*</span></label> <input type="text" name="parent-name-0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required oninput="validatePrimaryContact()">
                                </div>
                                <div><label class="block text-sm font-medium text-gray-700 mb-2">Relationship <span class="text-red-500">*</span></label> <select name="parent-relationship-0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required onchange="handleRelationshipChange(0); validatePrimaryContact()"> <option value="">Select relationship</option> <option value="mother">Mother</option> <option value="father">Father</option>
                                    <option value="grandfather">Grand father</option><option value="grandmother">Grand mother</option><option value="uncle">Uncle</option> <option value="Aunt">Aunt</option><option value="familyfriend">Family friend</option></select>
                                </div>
                                <div><label class="block text-sm font-medium text-gray-700 mb-2">Contact Number <span class="text-red-500">*</span></label> <input type="tel" name="parent-contact-0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter 10-digit mobile number" pattern="[0-9]{10}" maxlength="10" required oninput="validatePrimaryContact()">
                                    <p class="text-xs text-gray-500 mt-1">Enter 10 digits without spaces or special characters</p>
                                </div>
                            </div><!-- Guardian Relationship Field -->
                            <div class="mt-4" id="guardian-relationship-field-0" style="display: none;"><label class="block text-sm font-medium text-gray-700 mb-2">Guardian Relationship <span class="text-red-500">*</span></label> <input type="text" name="guardian-relationship-0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Uncle, Aunt, Grandfather, Family Friend, etc." required oninput="validatePrimaryContact()">
                                <p class="text-xs text-gray-500 mt-1">Please specify your relationship to the student</p>
                            </div>
                            <div class="mt-3"><label class="block text-sm font-medium text-gray-700 mb-2">Address (if different from student)</label> <textarea name="parent-address-0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="2" placeholder="Leave blank if same as student address"></textarea>
                            </div>
                            <div class="mt-3" id="aadhaar-field-0"><label class="block text-sm font-medium text-gray-700 mb-2">Aadhaar Number <span class="text-red-500">*</span></label> <input type="text" name="parent-aadhaar-0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter 12-digit Aadhaar number" pattern="[0-9]{12}" maxlength="12" required oninput="validatePrimaryContact()">
                                <p class="text-xs text-gray-500 mt-1">Required field for first parent/guardian. Enter 12 digits without spaces.</p>
                            </div>
                            <div class="mt-3"><label class="flex items-center"> <input type="checkbox" name="parent-primary-0" class="mr-2 text-blue-600 focus:ring-blue-500" checked onchange="setPrimaryContact(0)"> <span class="text-sm text-gray-700">Primary contact for emergencies</span> </label>
                            </div>
                        </div><!-- Add Parent/Guardian Button - positioned after first entry -->
                        <div class="text-center mb-4"><button type="button" id="add-parent-btn" onclick="addParentField()" class="bg-gray-300 text-gray-500 px-4 py-2 rounded-lg text-sm font-medium cursor-not-allowed transition-colors duration-200 border border-gray-300" disabled> + Add Parent/Guardian (Max 3) </button>
                            <p class="text-xs text-gray-500 mt-1">Complete primary contact details to add more parents/guardians</p>
                        </div>
                    </div>
            </div>

            <!-- Additional Notes -->
            <div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-2">Medical/Special Notes</label> <textarea id="enrollment-notes" class="w-full p-3 border border-gray-300 rounded-lg" rows="3" placeholder="Allergies, medical conditions, special requirements, etc."></textarea>
            </div>
            <div class="flex gap-3"><button type="submit" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700"> Enroll Student </button> <button type="button" onclick="closeModal('enrollment')" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-400"> Cancel </button>
            </div>
            <!-- Error message container -->
            <div id="error-message" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                <p class="text-red-700 text-sm font-medium"></p>
            </div>
          </div>
        </form>

    </div>
</div><!-- Attendance Modal -->
<!--<div id="attendance-modal" class="modal"> -->
    <div id="attendanceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-full p-4"><!-- Modal Content -->
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden"><!-- Modal Header -->
                <div class="bg-blue-600 text-white p-4 flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold">Student Attendance</h2>
                        <p class="text-blue-100">Mark student time in and time out</p>
                    </div><button onclick="closeAttendanceModal()" class="text-white hover:text-gray-200 text-2xl font-bold"> √ó </button>
                </div><!-- Modal Body -->
                <form id="attendance-form">
                <div class="p-6 overflow-y-auto max-h-[calc(90vh-140px)]"><!-- Time Setting Controls -->
                    <div class="bg-gray-50 rounded-lg p-4 shadow-sm border border-gray-200 mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-medium text-gray-900">Time Settings</h3>
                            <div class="flex items-center space-x-2"><label class="flex items-center"> <input type="checkbox" id="useCurrentTime" checked onchange="toggleTimeMode()" class="mr-2"> <span class="text-sm text-gray-600">Use current time</span> </label>
                            </div>
                        </div>
                        <div id="manualTimeControls" class="hidden">
                            <div class="flex items-center space-x-4">
                                <div><label class="block text-sm font-medium text-gray-700 mb-1">Set Time:</label> <input type="time" id="manualTime" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div class="pt-6"><button onclick="setCurrentTimeInInput()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors"> Set to Now </button>
                                </div>
                            </div>
                        </div>
                        <div id="currentTimeDisplay" class="text-sm text-gray-600">
                            Current time will be used: <span id="liveTime" class="font-medium"></span>
                        </div>
                    </div>
                    <div id="attendance-student-options" class="space-y-3 mb-6"><!-- Students will be populated here -->
                    </div><!-- Submit Button -->
                    <div class="text-center border-t border-gray-200 pt-6"><button type="submit"  class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg text-lg font-medium transition-colors shadow-md" onclick="submitAttendance();return false;"> Submit Attendance </button>
                    </div>
                </div>
                </form>
            </div>

        </div>
    </div>
<!--</div>-->

<!-- Meetings Modal -->
<div id="meetings-modal" class="modal">
    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-bold mb-4">Schedule Parent Meeting</h3>
        <form id="meetings-form">
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Student Name</label> <input type="text" id="meeting-student" class="w-full p-3 border border-gray-300 rounded-lg" required>
            </div>
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Parent Name</label> <input type="text" id="meeting-parent" class="w-full p-3 border border-gray-300 rounded-lg" required>
            </div>
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Meeting Date</label> <input type="date" id="meeting-date" class="w-full p-3 border border-gray-300 rounded-lg" required>
            </div>
            <div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-2">Purpose/Notes</label>
                <div class="voice-input-container"><textarea id="meeting-notes" class="w-full p-3 pr-12 border border-gray-300 rounded-lg" rows="3"></textarea> <button type="button" class="voice-button" onclick="toggleVoiceInput('meeting-notes')" title="Voice input">
                    <svg class="w-4 h-4" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M7 4a3 3 0 616 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 715 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" />
                    </svg></button>
                </div>
            </div>
            <div class="flex gap-3"><button type="submit" class="flex-1 bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700"> Schedule Meeting </button> <button type="button" onclick="closeModal('meetings')" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-400"> Cancel </button>
            </div>
        </form>
    </div>
</div><!-- Visits Modal -->
<div id="visits-modal" class="modal">
    <div class="bg-white rounded-xl p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-bold mb-4">Plan Home Visit</h3>
        <form id="visits-form">
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Select Student</label>
                <div class="relative"><input type="text" id="visit-student-search" placeholder="Search students by name or program..." class="w-full p-3 border border-gray-300 rounded-lg" oninput="filterVisitStudents()" onfocus="showVisitStudentList()" autocomplete="off"> <input type="hidden" id="visit-student" required> <!-- Student dropdown list -->
                    <div id="visit-student-list" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 max-h-60 overflow-y-auto shadow-lg" style="display: none;">
                        <div id="visit-student-options"><!-- Student options will be populated here -->
                        </div>
                    </div>
                </div>
                <div id="selected-visit-student-info" class="mt-2 text-sm text-gray-600" style="display: none;"><!-- Selected student info will appear here -->
                </div>
            </div><!-- Parent/Guardian Selection -->
            <div id="parent-selection-section" class="mb-4" style="display: none;"><label class="block text-sm font-medium text-gray-700 mb-2">Parent Met</label> <select id="visit-parent-attended" class="w-full p-3 border border-gray-300 rounded-lg" required onchange="toggleOtherParentField()"> <option value="">Select who was met</option> <!-- Parent options will be populated dynamically --> </select>
            </div><!-- Other Parent Field -->
            <div id="other-parent-field" class="mb-4" style="display: none;"><label class="block text-sm font-medium text-gray-700 mb-2">Other Person Details</label> <input type="text" id="visit-other-parent" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Name and relationship (e.g., John Doe - Neighbor)">
            </div>
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Visit Date</label> <input type="date" id="visit-date" class="w-full p-3 border border-gray-300 rounded-lg" required>
            </div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Purpose</label> <select id="home-visit-purpose" class="w-full p-3 border border-gray-300 rounded-lg" required> <option value="">Select purpose</option> <option value="AB1">Student was absent for 2-6 days</option> <option value="AB2">Student was absent for a week or more </option> <option value="DSC">To discuss a concern</option> <option value="FDB">For general feedback</option> </select>
            </div>
            <div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                <div class="voice-input-container"><textarea id="visit-notes" class="w-full p-3 pr-12 border border-gray-300 rounded-lg" rows="3" placeholder="Purpose of visit, observations, follow-up actions..."></textarea> <button type="button" class="voice-button" onclick="toggleVoiceInput('visit-notes')" title="Voice input">
                    <svg class="w-4 h-4" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" />
                    </svg></button>
                </div>
            </div>
            <div class="flex gap-3"><button type="submit" class="flex-1 bg-red-600 text-white py-3 rounded-lg font-medium hover:bg-red-700"> Save Details </button> <button type="button" onclick="closeModal('visits')" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-400"> Cancel </button>
            </div>
        </form>
    </div>
</div><!-- Activities Modal -->
<div id="activities-modal" class="modal">
    <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-bold mb-4">Log Activity</h3>
        <form id="activities-form">
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Activity Title</label> <input type="text" id="activity-title" class="w-full p-3 border border-gray-300 rounded-lg" required>
            </div>
           <!-- <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Student(s) Involved</label> <input type="text" id="activity-students" class="w-full p-3 border border-gray-300 rounded-lg" required>
            </div>-->
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Activity Description</label>
                <div class="voice-input-container"><textarea id="activity-description" class="w-full p-3 pr-12 border border-gray-300 rounded-lg" rows="3" required></textarea> <button type="button" class="voice-button" onclick="toggleVoiceInput('activity-description')" title="Voice input">
                    <svg class="w-4 h-4" fill="currentColor" viewbox="0 0 20 20">
                        <path fill-rule="evenodd"
                              d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" />
                    </svg></button>
                </div>
                <div class="mb-4 flex items-center">
                    <input id="teacher-participated" name="teacher-participated" type="checkbox"
                           class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <label for="teacher-participated" class="ml-2 block text-sm text-gray-700">
                        Anganwadi Teacher participated
                    </label>
                </div>

            </div><!-- Photo Upload Section -->
            <div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-2">Activity Photos (Optional)</label>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors" id="photo-upload-area">
                    <div class="mb-4">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewbox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </div>
                    <div class="text-sm text-gray-600"><label for="activity-photos" class="cursor-pointer"> <span class="text-indigo-600 hover:text-indigo-500 font-medium">Click to upload photos</span> <span> or drag and drop</span> </label> <input id="activity-photos" name="activity-photos" type="file" class="sr-only" multiple accept="image/*" onchange="handlePhotoUpload(event)">
                    </div>
                    <p class="text-xs text-gray-500 mt-1">PNG, JPG, GIF up to 10MB</p>
                </div><!-- Photo Preview Grid -->
                <div id="photo-preview-grid" class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4" style="display: none;"><!-- Photo previews will be inserted here -->
                </div><!-- Upload Status -->
                <div id="upload-status" class="mt-2 text-sm" style="display: none;"></div>
            </div>
            <div class="flex gap-3"><button type="submit" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700"> Log Activity </button> <button type="button" onclick="closeModal('activities')" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-400"> Cancel </button>
            </div>
        </form>
    </div>
</div><!-- Student List Modal -->
<div id="student-list-modal" class="modal">
    <div class="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold">Student List</h3><button onclick="closeModal('student-list')" class="text-gray-500 hover:text-gray-700"> <span class="text-2xl">√ó</span> </button>
        </div>
        <div class="mb-4"><input type="text" id="student-search" placeholder="Search students by name, program, or parent..." class="w-full p-3 border border-gray-300 rounded-lg" oninput="filterStudents()">
        </div>
        <div id="student-list-content">
            <div class="text-center text-gray-500 py-8">
                No students enrolled yet. Use the enrollment form to add students.
            </div>
        </div>
    </div>
</div><!-- Program List Modal -->
<div id="program-list-modal" class="modal">
    <div class="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold">Program List</h3><button onclick="closeModal('program-list')" class="text-gray-500 hover:text-gray-700"> <span class="text-2xl">√ó</span> </button>
        </div>
        <div id="program-list-content"><!-- Programs will be populated by JavaScript -->
        </div>
    </div>
</div><!-- Student Detail Modal -->
<div id="student-detail-modal" class="modal">
    <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold">Student Details</h3><button onclick="closeModal('student-detail')" class="text-gray-500 hover:text-gray-700"> <span class="text-2xl">√ó</span> </button>
        </div>
        <div id="student-detail-content"><!-- Student details will be populated by JavaScript -->
        </div>
    </div>
</div><!-- Learning Objectives List Modal -->
<div id="objectives-list-modal" class="modal">
    <div class="bg-white rounded-xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold">Learning Objectives</h3><button onclick="closeModal('objectives-list')" class="text-gray-500 hover:text-gray-700"> <span class="text-2xl">√ó</span> </button>
        </div>
        <div id="objectives-list-content">
            <div class="text-center text-gray-500 py-8">
                No learning objectives set yet. Use the Learning Objectives operation to create monthly goals.
            </div>
        </div>
    </div>
</div><!-- Learning Objectives Modal -->
<div id="objectives-modal" class="modal">
    <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-bold mb-4">Monthly Learning Objectives</h3>
        <form id="objectives-form">
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Month &amp; Year</label> <input type="month" id="objective-month" class="w-full p-3 border border-gray-300 rounded-lg" required>
            </div>
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Program</label> <select id="objective-program" class="w-full p-3 border border-gray-300 rounded-lg" required> <option value="">Select program</option> <option value="playgroup">Play Group (2 - 3 years)</option> <option value="preprimary1">Pre Primary 1 (3 - 4 years)</option> <option value="preprimary2">Pre Primary 2 (4 - 5 years)</option> <option value="preprimary3">Pre Primary 3 (5 - 6 years)</option> </select>
            </div>
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Subject Area</label> <select id="objective-subject" class="w-full p-3 border border-gray-300 rounded-lg" required> <option value="">Select subject area</option> <option value="literacy">Literacy &amp; Language</option> <option value="math">Mathematics</option> <option value="science">Science &amp; Discovery</option> <option value="social">Social &amp; Emotional</option> <option value="physical">Physical Development</option> <option value="creative">Creative Arts</option> <option value="life-skills">Life Skills</option> </select>
            </div>
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Learning Objective</label>
                <div class="voice-input-container"><textarea id="objective-goal" class="w-full p-3 pr-12 border border-gray-300 rounded-lg" rows="3" placeholder="What specific skill or knowledge should be achieved?" required></textarea> <button type="button" class="voice-button" onclick="toggleVoiceInput('objective-goal')" title="Voice input">
                    <svg class="w-4 h-4" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M7 4a3 3 0 616 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 715 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" />
                    </svg></button>
                </div>
            </div>
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Success Criteria</label>
                <div class="voice-input-container"><textarea id="objective-criteria" class="w-full p-3 pr-12 border border-gray-300 rounded-lg" rows="2" placeholder="How will you measure success?" required></textarea> <button type="button" class="voice-button" onclick="toggleVoiceInput('objective-criteria')" title="Voice input">
                    <svg class="w-4 h-4" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M7 4a3 3 0 616 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 715 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" />
                    </svg></button>
                </div>
            </div>
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Activities &amp; Strategies</label>
                <div class="voice-input-container"><textarea id="objective-activities" class="w-full p-3 pr-12 border border-gray-300 rounded-lg" rows="3" placeholder="What activities will help achieve this objective?"></textarea> <button type="button" class="voice-button" onclick="toggleVoiceInput('objective-activities')" title="Voice input">
                    <svg class="w-4 h-4" fill="currentColor" viewbox="0 0 20 20"><path fill-rule="evenodd" d="M7 4a3 3 0 616 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 715 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd" />
                    </svg></button>
                </div>
            </div>
            <div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-2">Priority Level</label> <select id="objective-priority" class="w-full p-3 border border-gray-300 rounded-lg" required> <option value="">Select priority</option> <option value="high">High Priority</option> <option value="medium">Medium Priority</option> <option value="low">Low Priority</option> </select>
            </div>
            <div class="flex gap-3"><button type="submit" class="flex-1 bg-teal-600 text-white py-3 rounded-lg font-medium hover:bg-teal-700"> Save Objective </button> <button type="button" onclick="closeModal('objectives')" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-400"> Cancel </button>
            </div>
        </form>
    </div>
</div><!-- Objective Evaluations Modal -->
<!-- Edit Reason Modal -->
<div id="edit-reason-modal" class="modal-overlay fixed inset-0 w-full h-full flex items-center justify-center hidden" style="z-index: 2000;">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Edit Achievement Status</h3>
        <p class="text-sm text-gray-600 mb-4">Please provide a reason for changing this student's achievement status:</p>
        <div class="mb-4"><label for="edit-reason-input" class="block text-sm font-semibold text-gray-700 mb-2">Reason</label> <textarea id="edit-reason-input" rows="4" placeholder="Enter reason for editing..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
        </div>
        <div class="flex gap-3 justify-end"><button id="cancel-edit-btn" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-semibold transition-colors"> Cancel </button> <button id="confirm-edit-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-colors"> Confirm Change </button>
        </div>
    </div>
</div><!-- evaluation Modal -->
<div id="evaluations-modal" class="modal-overlay fixed inset-0 w-full h-full flex items-center justify-center hidden" style="z-index: 1000;">
    <div class="bg-white rounded-xl sm:rounded-2xl shadow-2xl w-full h-full sm:h-auto sm:max-h-[90%] mx-0 sm:mx-4 sm:max-w-6xl" style="display: flex; flex-direction: column;"><!-- Modal Header -->
        <div class="border-b border-gray-200 p-4 sm:p-6 flex justify-between items-center flex-shrink-0">
            <h2 id="modal-title" class="text-xl sm:text-3xl font-bold text-gray-800">Student Evaluation</h2><button id="close-evalmodal-btn" onclick ='closeModal("evaluations")' class="text-gray-500 hover:text-gray-700 text-3xl leading-none">√ó</button>
        </div><!-- Modal Body -->
        <div class="p-4 sm:p-6 overflow-y-auto flex-grow"><!-- Filters Section -->
            <div class="grid grid-cols-1 gap-4 mb-6">
                <div><label for="program-select" class="block text-sm font-semibold text-gray-700 mb-2">Select Program</label> <select id="program-select"  onchange="changeProgramSelectEval(this);" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"> <option value="">Select a program</option> </select>
                </div>
                <div><label for="objective-select" class="block text-sm font-semibold text-gray-700 mb-2">Select Learning Objective</label> <select id="objective-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" disabled> <option value="">Select a program first</option> </select>
                </div>
            </div><!-- Search Bar -->
            <div class="mb-6"><label for="student-search" class="block text-sm font-semibold text-gray-700 mb-2">Search Students</label> <input type="text" id="eval-student-search" placeholder="Search students..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            </div><!-- Student List -->
            <div id="eval-student-list" class="space-y-3 sm:space-y-4 mb-6">
                <p class="text-gray-500 text-center py-8 text-sm sm:text-base">Select a program and learning objective to view students</p>
            </div>
        </div><!-- Modal Footer with Save Button -->
        <div class="border-t border-gray-200 p-4 sm:p-6 flex-shrink-0">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <p id="evaluation-count" class="text-sm text-gray-600">No changes to save</p><button id="save-btn" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-8 py-3 rounded-lg font-semibold transition-colors shadow-md" disabled> Save Evaluations </button>
            </div>
        </div>
    </div>
</div>
<!-- Plan of the day Modal -->
<div id="plan-modal" class="modal-overlay fixed inset-0 w-full h-full flex items-center justify-center hidden" style="z-index: 1000;">
    <div class="bg-white rounded-xl sm:rounded-2xl shadow-2xl w-full h-full sm:h-auto sm:max-h-[90%] mx-0 sm:mx-4 sm:max-w-4xl" style="display: flex; flex-direction: column;"><!-- Modal Header -->
        <div class="border-b border-gray-200 p-6 flex justify-between items-center flex-shrink-0 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-t-2xl">
            <h2 id="modal-title" class="text-2xl sm:text-3xl font-bold text-white">‚ú® View Plan for the Day</h2><button id="close-modal-btn" onclick = "closeModal('plan');" class="text-white hover:text-gray-200 text-3xl leading-none">√ó</button>
        </div><!-- Modal Body -->
        <div class="p-6 overflow-y-auto flex-grow">
            <form id="plan-form"><!-- Date Selection -->
                <div class="mb-6 bg-indigo-50 p-4 rounded-lg"><label for="plan-date" class="block text-sm font-semibold text-gray-700 mb-2">üìÖ Date</label> <input type="date" id="plan-date" required class="w-full px-4 py-3 border-2 border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-lg">
                </div>
                <div class="space-y-5"><!-- Basic Routine -->
                    <div class="activity-section p-4 rounded-lg border-2 border-gray-200">
                        <label for="basic-routine" class="block text-base font-bold text-gray-800 mb-2"> ü¶Å Basic Routine </label> <textarea id="basic-routine" rows="1" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">Discuss the basic routine activities - brush your teeth</textarea>
                    </div><!-- Social Development -->
                    <div class="activity-section p-4 rounded-lg border-2 border-gray-200">
                        <label for="social-development" class="block text-base font-bold text-gray-800 mb-2"> ü™∂üëÇüë∂ Social Development </label> <textarea id="social-development" rows="1" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">Play as a group - ring -o ring -o roses </textarea>
                    </div><!-- Expressive Development ‚Äì Conversation -->
                    <div class="activity-section p-4 rounded-lg border-2 border-gray-200"><label for="expressive-conversation" class="block text-base font-bold text-gray-800 mb-2"> üöåüè´üõèÔ∏è Expressive Development ‚Äì Conversation </label> <textarea id="expressive-conversation" rows="1" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">Talk about your family</textarea>
                    </div><!-- Expressive Development ‚Äì Songs -->
                    <div class="activity-section p-4 rounded-lg border-2 border-gray-200"><label for="expressive-songs" class="block text-base font-bold text-gray-800 mb-2"> üé∂üéµüé§ Expressive Development ‚Äì Songs </label> <textarea id="expressive-songs" rows="1" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">Song - chu chu train</textarea>
                    </div><!-- Physical Development ‚Äì Games -->
                    <div class="activity-section p-4 rounded-lg border-2 border-gray-200"><label for="physical-games" class="block text-base font-bold text-gray-800 mb-2"> üï∫üèÉüë∂ Physical Development ‚Äì Games </label> <textarea id="physical-games" rows="1" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">Jump like a frog</textarea>
                    </div><!-- Cognitive Development ‚Äì Creativity -->
                    <div class="activity-section p-4 rounded-lg border-2 border-gray-200"><label for="cognitive-creativity" class="block text-base font-bold text-gray-800 mb-2"> ‚úâÔ∏èüé®‚úèÔ∏è Cognitive Development ‚Äì Creativity </label> <textarea id="cognitive-creativity" rows="1"  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">Origami - paperboat</textarea>
                    </div>
                </div>
            </form>
        </div><!-- Modal Footer -->
        <div class="border-t border-gray-200 p-6 flex-shrink-0 bg-gray-50">
            <div class="flex flex-col sm:flex-row justify-end gap-3"><button id="plan-cancel-btn" type="button" onclick="closeModal('plan');" class="w-full sm:w-auto px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-semibold transition-colors"> Close </button>
            </div>
        </div>
    </div>
</div> <!--end - plan of the day modal-->
<!-- End of day review modal-->
<!-- Modal -->
<div id="review-modal" class="modal-overlay fixed inset-0 w-full h-full flex items-center justify-center hidden" style="z-index: 1000;">
    <div class="bg-white rounded-xl sm:rounded-2xl shadow-2xl w-full h-full sm:h-auto sm:max-h-[90%] mx-0 sm:mx-4 sm:max-w-5xl" style="display: flex; flex-direction: column;"><!-- Modal Header -->
        <div class="border-b border-gray-200 p-6 flex justify-between items-center flex-shrink-0 bg-gradient-to-r from-orange-600 to-amber-600 rounded-t-2xl">
            <h2 id="modal-title" class="text-xl sm:text-3xl font-bold text-white">üìù End of the Day - Review</h2><button id="close-eodmodal-btn" onclick="closeModal('review')" class="text-white hover:text-gray-200 text-3xl leading-none">√ó</button>
        </div><!-- Modal Body -->
        <div class="p-6 overflow-y-auto flex-grow">
            <form id="review-form"><!-- Date Selection -->
                <div class="mb-6 bg-orange-50 p-4 rounded-lg"><label for="review-date" class="block text-sm font-semibold text-gray-700 mb-2">üìÖ Review Date</label> <input type="date" id="review-date" required readonly class="w-full px-4 py-3 border-2 border-orange-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-lg bg-gray-100">
                </div><!-- Tasks & Activities Section -->
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">‚úÖ Tasks &amp; Activities Completed</h3>
                    <div class="space-y-4"><!-- Attendance -->
                        <div><label for="attendance-status" class="block text-sm font-semibold text-gray-700 mb-2"> üë• Attendance (Recorded 2 In, 2 Out timings) </label> <select id="attendance-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"> <option value="">Select status</option> <option value="Yes">Yes</option> <option value="No">No</option> </select>
                        </div><!-- Kids After Lunch -->
                        <div><label for="kids-after-lunch" class="block text-sm font-semibold text-gray-700 mb-2"> üç± Kids leaving after lunch </label> <input type="text" id="kids-after-lunch" placeholder="e.g., 5/20" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        </div><!-- Parents Helping -->
                        <div><label for="parents-helping" class="block text-sm font-semibold text-gray-700 mb-2"> üë®‚Äçüë©‚Äçüëß Parents helping with AWC </label> <select id="parents-helping" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"> <option value="">Select status</option> <option value="Yes - 1 parent">Yes - 1 parent</option> <option value="Yes - 2 parents">Yes - 2 parents</option> <option value="Yes - 3+ parents">Yes - 3+ parents</option> <option value="No">No</option> </select>
                        </div><!-- Home Visits -->
                        <div><label for="home-visits" class="block text-sm font-semibold text-gray-700 mb-2"> üè† Home Visits (Recorded 1 visit) </label> <select id="home-visits" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"> <option value="">Select status</option> <option value="Completed - 1 visit">Completed - 1 visit</option> <option value="Completed - 2 visits">Completed - 2 visits</option> <option value="Completed - 3+ visits">Completed - 3+ visits</option> <option value="Not Completed">Not Completed</option> <option value="Not Applicable">Not Applicable</option> </select>
                        </div><!-- Photos Sent -->
                        <div><label for="photos-sent" class="block text-sm font-semibold text-gray-700 mb-2"> üì∏ Photos of activity sent (Recorded 2 activities)</label> <select id="photos-sent" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"> <option value="">Select status</option> <option value="Yes - Sent">Yes - Sent</option> <option value="No - Not Sent">No - Not Sent</option> <option value="No Activities Today">No Activities Today</option> </select>
                        </div><!-- Phone Calls -->
                        <div><label for="phone-calls" class="block text-sm font-semibold text-gray-700 mb-2"> üìû Phone calls made </label> <input type="text" id="phone-calls" placeholder="e.g., Yes - 5 calls" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        </div><!-- Shine and Sort -->
                        <div><label for="shine-sort" class="block text-sm font-semibold text-gray-700 mb-2"> ‚ú® Shine and sort ‚Äì AWC </label> <textarea id="shine-sort" rows="3" placeholder="Describe cleaning and organizing activities..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"></textarea>
                        </div><!-- TLM Prepared -->
                        <div><label for="tlm-prepared" class="block text-sm font-semibold text-gray-700 mb-2"> üìö Tomorrow's TLM prepared </label> <select id="tlm-prepared" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"> <option value="">Select status</option> <option value="Yes - Fully Prepared">Yes - Fully Prepared</option> <option value="Partially Prepared">Partially Prepared</option> <option value="Not Prepared">Not Prepared</option> <option value="Not Required">Not Required</option> </select>
                        </div>
                    </div>
                </div>
                <div class="section-divider"></div><!-- Reflections Section -->
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">üí≠ Daily Reflections</h3>
                    <div class="space-y-4"><!-- Happy Moments -->
                        <div><label for="happy-moments" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center justify-between"> <span>üòä Happy moments</span> <button type="button" class="voice-btn bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded-full text-xs" onclick="startVoiceInput('happy-moments')"> üé§ Voice </button> </label> <textarea id="happy-moments" rows="3" placeholder="What made you happy today?" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"></textarea>
                        </div><!-- Challenges -->
                        <div><label for="challenges" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center justify-between"> <span>‚ö†Ô∏è Challenges &amp; Difficulties</span> <button type="button" class="voice-btn bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded-full text-xs" onclick="startVoiceInput('challenges')"> üé§ Voice </button> </label> <textarea id="challenges" rows="3" placeholder="What challenges did you face?" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"></textarea>
                        </div><!-- Improvements -->
                        <div><label for="improvements" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center justify-between"> <span>üéØ Improvement &amp; Next Steps</span> <button type="button" class="voice-btn bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded-full text-xs" onclick="startVoiceInput('improvements')"> üé§ Voice </button> </label> <textarea id="improvements" rows="3" placeholder="What can be improved? What are your next steps?" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"></textarea>
                        </div><!-- Other Notes -->
                        <div><label for="other-notes" class="block text-sm font-semibold text-gray-700 mb-2 flex items-center justify-between"> <span>üìù Other Observations &amp; Notes</span> <button type="button" class="voice-btn bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded-full text-xs" onclick="startVoiceInput('other-notes')"> üé§ Voice </button> </label> <textarea id="other-notes" rows="3" placeholder="Any other observations or notes..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"></textarea>
                        </div>
                    </div>
                </div>
            </form>
        </div><!-- Modal Footer -->
        <div class="border-t border-gray-200 p-6 flex-shrink-0 bg-gray-50">
            <div class="flex flex-col sm:flex-row justify-end gap-3"><button id="cancel-btn" type="button" class="w-full sm:w-auto px-6 py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-semibold transition-colors" onclick="closeModal('review')"> Cancel </button> <button id="save-btn" type="submit" class="w-full sm:w-auto px-8 py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-semibold transition-colors shadow-md" onclick="closeModal('review')" > üíæ Save Review </button>
            </div>
        </div>
    </div>
</div>
<!-- Attendance Reports Modal -->
<div id="attendance-reports-modal" class="modal">
    <div class="bg-white rounded-xl p-6 max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold">Attendance Reports</h3><button onclick="closeModal('attendance-reports')" class="text-gray-500 hover:text-gray-700"> <span class="text-2xl">√ó</span> </button>
        </div><!-- Report Type Selection -->
        <div class="mb-6">
            <div class="flex gap-4 border-b"><button id="student-report-tab" class="px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600" onclick="switchReportTab('student')"> Student Report </button> <button id="class-report-tab" class="px-4 py-2 font-medium text-gray-500 hover:text-gray-700" onclick="switchReportTab('class')"> Class Report </button>
            </div>
        </div><!-- Student Report Section -->
        <div id="student-report-section">
            <div class="mb-4">
                <div class="grid md:grid-cols-3 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Select Student</label> <select id="report-student-select" class="w-full p-3 border border-gray-300 rounded-lg" onchange="generateStudentReport()"> <option value="">Choose a student</option> </select>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">From Date</label> <input type="date" id="student-from-date" class="w-full p-3 border border-gray-300 rounded-lg" onchange="generateStudentReport()">
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">To Date</label> <input type="date" id="student-to-date" class="w-full p-3 border border-gray-300 rounded-lg" onchange="generateStudentReport()">
                    </div>
                </div>
            </div>
            <div id="student-report-content">
                <div class="text-center text-gray-500 py-8">
                    Select a student and date range to view attendance report
                </div>
            </div>
        </div><!-- Class Report Section -->
        <div id="class-report-section" style="display: none;">
            <div class="mb-4">
                <div class="grid md:grid-cols-3 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">Select Program</label> <select id="report-program-select" class="w-full p-3 border border-gray-300 rounded-lg" onchange="generateClassReport()"> <option value="">Choose a program</option> <option value="playgroup">Play Group (2 - 3 years)</option> <option value="preprimary1">Pre Primary 1 (3 - 4 years)</option> <option value="preprimary2">Pre Primary 2 (4 - 5 years)</option> <option value="preprimary3">Pre Primary 3 (5 - 6 years)</option> </select>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">From Date</label> <input type="date" id="class-from-date" class="w-full p-3 border border-gray-300 rounded-lg" onchange="generateClassReport()">
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-2">To Date</label> <input type="date" id="class-to-date" class="w-full p-3 border border-gray-300 rounded-lg" onchange="generateClassReport()">
                    </div>
                </div>
            </div>
            <div id="class-report-content">
                <div class="text-center text-gray-500 py-8">
                    Select a program and date range to view class attendance report
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    // Default configuration
    const defaultConfig = {
        educator_name: "Devaki",
        school_name: "Anganwadi - Hyderabad",
        welcome_message: "Welcome back! Ready for another great day?"
    };



    // Program definitions
    const programs = [
        {
            id: 'playgroup',
            name: 'Play Group',
            ageRange: '2 - 3 years',
            capacity: 12,
            schedule: 'Mon-Fri, 8:00 AM - 12:00 PM',
            description: 'Sensory play, basic social skills, music and movement',
            color: 'pink'
        },
        {
            id: 'preprimary1',
            name: 'Pre Primary 1',
            ageRange: '3 - 4 years',
            capacity: 16,
            schedule: 'Mon-Fri, 8:00 AM - 1:00 PM',
            description: 'Creative arts, early literacy, number recognition',
            color: 'green'
        },
        {
            id: 'preprimary2',
            name: 'Pre Primary 2',
            ageRange: '4 - 5 years',
            capacity: 20,
            schedule: 'Mon-Fri, 8:00 AM - 2:00 PM',
            description: 'Reading readiness, basic math, science exploration',
            color: 'blue'
        },
        {
            id: 'preprimary3',
            name: 'Pre Primary 3',
            ageRange: '5 - 6 years',
            capacity: 25,
            schedule: 'Mon-Fri, 8:00 AM - 3:00 PM',
            description: 'School readiness, advanced literacy, problem solving',
            color: 'purple'
        }
    ];

    // Data handler for SDK
    var dataHandler = {
        onDataChanged: function(data) {
            currentData = data;
            recordCount = data.length;
            renderActivitiesList(data);
            updateStats(data);
            updateStudentCount(data);
        }
    };

    // Initialize Data SDK
    function initializeDataSDK() {
        if (window.dataSdk) {
            window.dataSdk.init(dataHandler).then(function(result) {
                if (!result.isOk) {
                    console.error("Failed to initialize data SDK");
                }
            }).catch(function(error) {
                console.error("Error initializing data SDK:", error);
            });
        }
    }


    // Update all relationship dropdowns to show only available options
    function updateRelationshipOptions() {
        var allRelationshipSelects = document.querySelectorAll('[name*="parent-relationship-"]');
        var selectedRelationships = [];

        // Collect all currently selected relationships
        for (var i = 0; i < allRelationshipSelects.length; i++) {
            var select = allRelationshipSelects[i];
            if (select.value) {
                selectedRelationships.push(select.value);
            }
        }

        // Update each dropdown
        for (var j = 0; j < allRelationshipSelects.length; j++) {
            var select = allRelationshipSelects[j];
            var currentValue = select.value;
            var options = select.querySelectorAll('option');

            // Reset all options to be enabled and visible
            for (var k = 0; k < options.length; k++) {
                var option = options[k];
                option.disabled = false;
                option.style.display = '';
            }

            // Disable and hide options that are already selected in other dropdowns
            for (var l = 0; l < selectedRelationships.length; l++) {
                var selectedRel = selectedRelationships[l];
                if (selectedRel !== currentValue && selectedRel !== '') {
                    var optionToDisable = select.querySelector('option[value="' + selectedRel + '"]');
                    if (optionToDisable) {
                        optionToDisable.disabled = true;
                        optionToDisable.style.display = 'none';
                    }
                }
            }
        }
    }

    // Filter students based on search input
    function filterStudents() {
        var searchTerm = document.getElementById('student-search').value.toLowerCase();
        var enrollments = currentData.filter(function(item) {
            return item.type === 'enrollment';
        });

        if (searchTerm === ''){
        // Sort students by name
            students = enrollments.sort(function(a, b) {
                var nameA = (a.student.student_first_name + ' ' + a.student.student_last_name).toLowerCase();
                var nameB = (b.student.student_first_name + ' ' + b.student.student_last_name).toLowerCase();
                return nameA.localeCompare(nameB);
            });

        }

        if (searchTerm) {
            students = enrollments.filter(function(enrollment) {
                var fullName = (enrollment.student.student_first_name + ' ' + enrollment.student.student_last_name).toLowerCase();
                var parent = enrollment.student.guardians.find(function (p) { return p.is_primary == true; });
                var parentName = parent.name.toLowerCase();
                var program = programs.find(function(p) { return p.id === enrollment.student_program; });
                var programName = program ? program.name.toLowerCase() : '';

                return fullName.includes(searchTerm) ||
                       parentName.includes(searchTerm) ||
                       programName.includes(searchTerm);
            });
        }

        renderFilteredStudentList(students);
    }

    // Render filtered student list
    function renderFilteredStudentList(students) {
        var container = document.getElementById('student-list-content');

        if (students.length === 0) {
            var searchTerm = document.getElementById('student-search').value;
            if (searchTerm) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">No students found matching "' + searchTerm + '"</div>';
            } else {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">No students enrolled yet. Use the enrollment form to add students.</div>';
            }
            return;
        }

        var html = '<div class="grid gap-4">';
        for (var i = 0; i < students.length; i++) {
            var enrollment = students[i];
            var student = enrollment.student;

            var age = calculateAge(student.student_dob);
            var program = programs.find(function(p) { return p.id === enrollment.student_program; });
            var enrollDate = new Date(enrollment.date_of_joining).toLocaleDateString();
            var programName = program ? program.name : 'Unknown';
            var programColor = program ? program.color : 'gray';
            var parent = student.guardians.find(function (p) { return p.is_primary == true; });

            html += '<div class="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 cursor-pointer" onclick="showStudentDetail(\'' + student.student_id + '\')">';
            html += '<div class="flex justify-between items-start">';
            html += '<div class="flex-1">';
            html += '<h4 class="text-lg font-semibold text-gray-900">';
            html += student.student_first_name + ' ' + student.student_last_name;
            html += '</h4>';
            html += '<p class="text-sm text-gray-600">Age: ' + age + ' years ‚Ä¢ Program: ' + programName + '</p>';
            html += '<p class="text-sm text-gray-500">Enrolled: ' + enrollDate + '</p>';
            html += '<p class="text-sm text-gray-500">Parent: ' + parent.name + ' (' + parent.relationship + ')</p>';
            html += '</div>';
            html += '<div class="text-right">';
            html += '<span class="inline-block w-3 h-3 bg-' + programColor + '-400 rounded-full"></span>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
        }
        html += '</div>';
        container.innerHTML = html;
    }

    // Update time display
    function updateTime() {
        const now = new Date();
        document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Update student count
    function updateStudentCount(data) {
        var enrolledStudents = data.filter(function(item) {
            return item.type === 'enrollment';
        });
        var count = enrolledStudents.length;
        var totalStudentsEl = document.getElementById('total-students');
        var enrolledCountEl = document.getElementById('enrolled-count');
        if (totalStudentsEl) totalStudentsEl.textContent = count;
        if (enrolledCountEl) enrolledCountEl.textContent = count;

        // Update objectives count
        var objectives = data.filter(function(item) {
            return item.type === 'objective';
        });
        var objectivesCountEl = document.getElementById('objectives-count');
        if (objectivesCountEl) objectivesCountEl.textContent = objectives.length;
    }

    // Update stats based on data
    function updateStats(data) {
        var todayString = new Date().toDateString();
        var attendanceToday = data.filter(function(item) {
            return item.type === 'attendance' &&
                   new Date(item.date).toDateString() === todayString;
        });

        var presentCount = attendanceToday.filter(function(item) {
            return item.status === 'present' || item.status === 'late';
        }).length;

        var homeVisitsToday = data.filter(function(item) {
            return item.type === 'visits' &&
                   new Date(item.date).toDateString() === todayString;
        }).length;

        var activitiesToday = data.filter(function(item) {
            return item.type === 'activities' &&
                   new Date(item.date).toDateString() === todayString;
        }).length;

        var presentTodayEl = document.getElementById('present-today');
        var homeVisitsTodayEl = document.getElementById('home-visits-today');
        var activitiesLoggedEl = document.getElementById('activities-logged');

        if (presentTodayEl) presentTodayEl.textContent = presentCount;
        if (homeVisitsTodayEl) homeVisitsTodayEl.textContent = homeVisitsToday;
        if (activitiesLoggedEl) activitiesLoggedEl.textContent = activitiesToday;
    }

    // Calculate age from date of birth
    function calculateAge(dob) {
        const today = new Date();
        const birthDate = new Date(dob);
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();

        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }

        return age;
    }

    // Render student list
    function renderStudentList() {
        var container = document.getElementById('student-list-content');
        var students = currentData.filter(function(item) {
            return item.type === 'enrollment';
        });

        renderFilteredStudentList(students);
    }

    // Show student detail
    function showStudentDetail(studentId) {
    var enrollments = currentData.filter(function(item) {
            return item.type === 'enrollment';
        });
        var enrollment = enrollments.find(function(item) {
            return item.student.student_id === studentId;
        });
        if (!enrollment) return;

        var student = enrollment.student;
        var age = calculateAge(student.student_dob);
        var program = programs.find(function(p) {
            return p.id === enrollment.student_program;
        });
        var enrollDate = new Date(enrollment.created_at).toLocaleDateString();
        var dobFormatted = new Date(student.student_dob).toLocaleDateString();
        var dojFormatted = new Date(enrollment.date_of_joining).toLocaleDateString();
        var programName = program ? program.name : 'Unknown';
        var programAgeRange = program ? program.ageRange : 'N/A';
        var programSchedule = program ? program.schedule : 'N/A';

        var content = document.getElementById('student-detail-content');
        var html = '<div class="space-y-6">';

        // Student Info
        html += '<div class="bg-blue-50 rounded-lg p-4">';
        html += '<h4 class="text-lg font-semibold text-blue-900 mb-3">Student Information</h4>';
        html += '<div class="grid md:grid-cols-2 gap-4 text-sm">';
        html += '<div><strong>Name:</strong> ' + student.student_first_name + ' ' + student.student_last_name + '</div>';
        html += '<div><strong>Age:</strong> ' + age + ' years</div>';
        html += '<div><strong>Date of Birth:</strong> ' + dobFormatted + '</div>';
        html += '<div><strong>Date of Joining:</strong> ' + dojFormatted + '</div>';
        html += '<div><strong>Gender:</strong> ' + (student.gender ? student.gender.charAt(0).toUpperCase() + student.gender.slice(1) : 'Not specified') + '</div>';
        html += '<div><strong>Social Category:</strong> ' + (student.student_social_category || 'Not specified') + '</div>';
        html += '<div class="md:col-span-2"><strong>Contact:</strong> ' + student.contact + '</div>';
        html += '<div class="md:col-span-2"><strong>Address:</strong> ' + student.address + '</div>';
        html += '</div>';
        html += '</div>';

        // Parent Info
        html += '<div class="bg-green-50 rounded-lg p-4">';
        html += '<h4 class="text-lg font-semibold text-green-900 mb-3">Parent/Guardian Information</h4>';

        // Check if we have multiple parents data

        if (student.guardians) {
            try {
                console.log(student.guardians.length);
               // var parentsData = JSON.parse(student.guardians);
                for (var p = 0; p < student.guardians.length; p++) {
                    var parent = student.guardians[p];
                    console.log("parent : "+parent);
                    var isPrimary = parent.is_primary;

                    html += '<div class="mb-4 ' + (p > 0 ? 'border-t border-green-200 pt-3' : '') + '">';
                    html += '<div class="flex items-center mb-2">';
                    html += '<h5 class="font-medium text-green-800">Parent/Guardian ' + (p + 1) + '</h5>';
                    if (isPrimary) {
                        html += '<span class="ml-2 px-2 py-1 bg-green-200 text-green-800 text-xs rounded-full">Primary Contact</span>';
                    }
                    html += '</div>';
                    html += '<div class="grid md:grid-cols-2 gap-4 text-sm">';
                    html += '<div><strong>Name:</strong> ' + parent.name + '</div>';
                    html += '<div><strong>Relationship:</strong> ' + parent.relationship + '</div>';
                    html += '<div><strong>Contact:</strong> ' + parent.contact + '</div>';
                    if (parent.aadhaar && parent.relationship === 'mother') {
                        html += '<div><strong>Aadhaar Number:</strong> ' + parent.aadhaar + '</div>';
                    }
                    if (parent.address) {
                        html += '<div class="md:col-span-2"><strong>Address:</strong> ' + parent.address + '</div>';
                    }
                    html += '</div>';
                    html += '</div>';
                }
            } catch (e) {
                // Fallback to old format
                html += '<div class="grid md:grid-cols-2 gap-4 text-sm">';
                html += '<div><strong>Name:</strong> ' + student.name + '</div>';
                html += '<div><strong>Relationship:</strong> ' + student.relationship + '</div>';
                html += '<div class="md:col-span-2"><strong>Contact:</strong> ' + student.parent_contact + '</div>';
                if (student.parent_email) {
                    html += '<div class="md:col-span-2"><strong>Email:</strong> ' + student.parent_email + '</div>';
                }
                html += '</div>';
            }
        } else {
            // Fallback to old format
            html += '<div class="grid md:grid-cols-2 gap-4 text-sm">';
            html += '<div><strong>No parent information found.</div>';
            //html += '<div><strong>Relationship:</strong> ' + student.parent_relationship + '</div>';
           // html += '<div class="md:col-span-2"><strong>Contact:</strong> ' + student.parent_contact + '</div>';
            html += '</div>';
        }

        html += '</div>';

        // Program Info
        html += '<div class="bg-purple-50 rounded-lg p-4">';
        html += '<h4 class="text-lg font-semibold text-purple-900 mb-3">Program Information</h4>';
        html += '<div class="text-sm">';
        html += '<div class="mb-2"><strong>Program:</strong> ' + programName + '</div>';
        html += '<div class="mb-2"><strong>Age Range:</strong> ' + programAgeRange + '</div>';
        html += '<div class="mb-2"><strong>Schedule:</strong> ' + programSchedule + '</div>';
        html += '<div><strong>Enrollment entry created on:</strong> ' + enrollDate + '</div>';
        html += '</div>';
        html += '</div>';

        // Notes
        if (student.notes) {
            html += '<div class="bg-yellow-50 rounded-lg p-4">';
            html += '<h4 class="text-lg font-semibold text-yellow-900 mb-3">Medical/Special Notes</h4>';
            html += '<p class="text-sm text-gray-700">' + student.notes + '</p>';
            html += '</div>';
        }

        html += '</div>';
        content.innerHTML = html;

        openModal('student-detail');
    }

    // Render program list
    function renderProgramList() {
        var container = document.getElementById('program-list-content');
        var enrolledStudents = currentData.filter(function(item) {
            return item.type === 'enrollment';
        });

        var html = '<div class="grid gap-6">';

        for (var i = 0; i < programs.length; i++) {
            var program = programs[i];
            var enrolledCount = enrolledStudents.filter(function(s) {
                return s.student_program === program.id;
            }).length;
            var enrollmentText = enrolledCount === 1 ? '1 child enrolled' : enrolledCount + ' children enrolled';

            html += '<div class="border border-gray-200 rounded-lg p-6">';
            html += '<div class="flex justify-between items-start mb-4">';
            html += '<div class="flex items-center">';
            html += '<div class="w-4 h-4 bg-' + program.color + '-400 rounded-full mr-3"></div>';
            html += '<div>';
            html += '<h4 class="text-lg font-semibold text-gray-900">' + program.name + '</h4>';
            html += '<p class="text-sm text-gray-600">' + program.ageRange + '</p>';
            html += '</div>';
            html += '</div>';
            html += '<div class="text-right">';
            html += '<div class="text-2xl font-bold text-' + program.color + '-600">' + enrolledCount + '</div>';
            html += '<div class="text-xs text-gray-500">Children</div>';
            html += '</div>';
            html += '</div>';

            html += '<p class="text-sm text-gray-700 mb-3">' + program.description + '</p>';
            html += '<p class="text-sm text-gray-600 mb-3"><strong>Schedule:</strong> ' + program.schedule + '</p>';

            html += '<div class="text-sm text-' + program.color + '-600 font-medium">';
            html += enrollmentText;
            html += '</div>';
            html += '</div>';
        }

        html += '</div>';
        container.innerHTML = html;
    }

    // Render activities list
    function renderActivitiesList(data) {
        var container = document.getElementById('activities-list');

        if (data.length === 0) {
            container.innerHTML = '<div class="p-4 text-center text-gray-500">No activities recorded yet. Start by using the operation cards above!</div>';
            return;
        }

        // Sort by date (newest first) - IE compatible
        var sortedData = data.slice().sort(function(a, b) {
            return new Date(b.created_at) - new Date(a.created_at);
        });
        var recentData = sortedData.slice(0, 10); // Show last 10 activities

        var html = '';
        for (var i = 0; i < recentData.length; i++) {
            var item = recentData[i];
            var date = new Date(item.created_at);
            var timeAgo = getTimeAgo(date);
            var icon = getTypeIcon(item.type);
            var color = getTypeColor(item.type);
            var description = item.description || item.notes || '';

            html += '<div class="p-4 hover:bg-gray-50">';
            html += '<div class="flex items-start">';
            html += '<div class="bg-' + color + '-100 p-2 rounded-full mr-3 mt-1">';
            html += '<span class="text-sm">' + icon + '</span>';
            html += '</div>';
            html += '<div class="flex-1">';
            html += '<h4 class="font-medium text-gray-900">' + item.title + '</h4>';
            html += '<p class="text-sm text-gray-600">' + description + '</p>';
            if (item.student_first_name) {
                html += '<p class="text-xs text-gray-500 mt-1">Student: ' + item.student_first_name + ' ' + item.student_last_name + '</p>';
            }
            html += '<p class="text-xs text-gray-400 mt-1">' + timeAgo + '</p>';
            html += '</div>';
            html += '</div>';
            html += '</div>';
        }

        container.innerHTML = html;
    }

    function getTypeIcon(type) {
        const icons = {
            enrollment: 'üìù',
            attendance: '‚úÖ',
            journal: 'üìñ',
            meetings: 'üë•',
            visits: 'üè†',
            activities: 'üéØ',
            objectives: 'üéì',
            evaluations: 'üìä'
        };
        return icons[type] || 'üìã';
    }

    function getTypeColor(type) {
        const colors = {
            enrollment: 'blue',
            attendance: 'green',
            journal: 'yellow',
            meetings: 'purple',
            visits: 'red',
            activities: 'indigo',
            objectives: 'teal',
            evaluations: 'orange'
        };
        return colors[type] || 'gray';
    }

    function getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins} minutes ago`;
        if (diffHours < 24) return `${diffHours} hours ago`;
        return `${diffDays} days ago`;
    }

    // Render objectives list
    function renderObjectivesList() {
        var container = document.getElementById('objectives-list-content');
        var objectives = currentData.filter(function(item) {
            return item.type === 'objectives';
        });

        if (objectives.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">No learning objectives set yet. Use the Learning Objectives operation to create monthly goals.</div>';
            return;
        }

        // Group objectives by month
        var objectivesByMonth = {};
        for (var i = 0; i < objectives.length; i++) {
            var obj = objectives[i];
            var monthKey = obj.month || 'Unknown';
            if (!objectivesByMonth[monthKey]) {
                objectivesByMonth[monthKey] = [];
            }
            objectivesByMonth[monthKey].push(obj);
        }

        var html = '<div class="space-y-6">';

        // Sort months (newest first)
        var sortedMonths = Object.keys(objectivesByMonth).sort().reverse();

        for (var m = 0; m < sortedMonths.length; m++) {
            var month = sortedMonths[m];
            var monthObjectives = objectivesByMonth[month];
            var monthDate = new Date(month + '-01');
            var monthName = monthDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });

            html += '<div class="bg-gray-50 rounded-lg p-6">';
            html += '<h4 class="text-lg font-semibold text-gray-900 mb-4">' + monthName + '</h4>';
            html += '<div class="grid gap-4">';

            for (var j = 0; j < monthObjectives.length; j++) {
                var objective = monthObjectives[j];
                var priorityColor = objective.priority === 'high' ? 'red' :
                                  objective.priority === 'medium' ? 'yellow' : 'green';
                var subjectName = getSubjectName(objective.subject);

                html += '<div class="bg-white rounded-lg p-4 border-l-4 border-' + priorityColor + '-400">';
                html += '<div class="flex justify-between items-start mb-2">';
                html += '<div class="flex-1">';
                html += '<h5 class="font-semibold text-gray-900">' + subjectName + '</h5>';
                html += '<p class="text-sm text-gray-600">Program: ' + getProgramName(objective.program) + '</p>';
                html += '</div>';
                html += '<span class="text-xs px-2 py-1 bg-' + priorityColor + '-100 text-' + priorityColor + '-800 rounded-full">';
                html += objective.priority.charAt(0).toUpperCase() + objective.priority.slice(1);
                html += '</span>';
                html += '</div>';
                html += '<p class="text-sm text-gray-700 mb-2"><strong>Goal:</strong> ' + objective.goal + '</p>';
                html += '<p class="text-sm text-gray-600"><strong>Success Criteria:</strong> ' + objective.criteria + '</p>';
                if (objective.activities) {
                    html += '<p class="text-sm text-gray-600 mt-2"><strong>Activities:</strong> ' + objective.activities + '</p>';
                }
                html += '</div>';
            }

            html += '</div>';
            html += '</div>';
        }

        html += '</div>';
        container.innerHTML = html;
    }

    function getSubjectName(subject) {
        var subjects = {
            'literacy': 'Literacy & Language',
            'math': 'Mathematics',
            'science': 'Science & Discovery',
            'social': 'Social & Emotional',
            'physical': 'Physical Development',
            'creative': 'Creative Arts',
            'life-skills': 'Life Skills'
        };
        return subjects[subject] || subject;
    }

    function getProgramName(programId) {
        var program = programs.find(function(p) { return p.id === programId; });
        return program ? program.name : programId;
    }

    // Populate evaluation objectives dropdown
    function populateEvaluationObjectives() {
        var select = document.getElementById('evaluation-objective');
        var objectives = currentData.filter(function(item) {
            return item.type === 'objectives';
        });

        // Clear existing options except the first one
        select.innerHTML = '<option value="">Choose an objective to evaluate</option>';

        for (var i = 0; i < objectives.length; i++) {
            var obj = objectives[i];
            var monthDate = new Date(obj.month + '-01');
            var monthName = monthDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
            var subjectName = getSubjectName(obj.subject);
            var programName = getProgramName(obj.program);
            var optionText = monthName + ' - ' + subjectName + ' (' + programName + ')';

            var option = document.createElement('option');
            option.value = obj.id;
            option.textContent = optionText;
            select.appendChild(option);
        }
    }

    // Photo upload handling
    function handlePhotoUpload(event) {
        var files = event.target.files;
        var statusDiv = document.getElementById('upload-status');
        var previewGrid = document.getElementById('photo-preview-grid');

        if (files.length === 0) return;

        // Check total photo limit
        if (uploadedPhotos.length + files.length > 1) {
            statusDiv.innerHTML = '<span class="text-red-600">Maximum 1 photo allowed. Please remove some photos first.</span>';
            statusDiv.style.display = 'block';
            return;
        }

        statusDiv.innerHTML = '<span class="text-blue-600">Processing photos...</span>';
        statusDiv.style.display = 'block';

        var validFiles = [];
        var errors = [];

        // Validate files
        for (var i = 0; i < files.length; i++) {
            var file = files[i];

            // Check file type
            if (!file.type.startsWith('image/')) {
                errors.push(file.name + ' is not an image file');
                continue;
            }

            // Check file size (10MB limit)
            if (file.size > 10 * 1024 * 1024) {
                errors.push(file.name + ' is too large (max 10MB)');
                continue;
            }

            validFiles.push(file);
        }

        if (errors.length > 0) {
            statusDiv.innerHTML = '<span class="text-red-600">' + errors.join(', ') + '</span>';
            return;
        }

        // Process valid files
        var processedCount = 0;
        for (var j = 0; j < validFiles.length; j++) {
            var file = validFiles[j];
            var reader = new FileReader();

            reader.onload = function(e) {

            console.log(e);

                var photoData = {
                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    filename: file.name,
                    size: file.size,
                    type: file.type,
                    data: e.target.result,
                    uploadDate: new Date().toISOString()
                };

                uploadedPhotos.push(photoData);
                addPhotoPreview(photoData);

                processedCount++;
                if (processedCount === validFiles.length) {
                    statusDiv.innerHTML = '<span class="text-green-600">' + validFiles.length + ' photo(s) uploaded successfully</span>';
                    setTimeout(function() {
                        statusDiv.style.display = 'none';
                    }, 3000);
                }
            }.bind(null, file);

            reader.readAsDataURL(file);
        }

        // Clear the input
        event.target.value = '';
    }

    function addPhotoPreview(photoData) {
        var previewGrid = document.getElementById('photo-preview-grid');
        previewGrid.style.display = 'grid';

        var previewDiv = document.createElement('div');
        previewDiv.className = 'relative group';
        previewDiv.setAttribute('data-photo-id', photoData.id);

        previewDiv.innerHTML = `
            <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden">
                <img src="${photoData.data}" alt="${photoData.filename}" class="w-full h-full object-cover">
            </div>
            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-200 rounded-lg flex items-center justify-center">
                <button type="button" onclick="removePhoto('${photoData.id}')" class="opacity-0 group-hover:opacity-100 bg-red-600 text-white rounded-full p-2 hover:bg-red-700 transition-all">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="mt-1 text-xs text-gray-500 truncate">${photoData.filename}</div>
            <div class="text-xs text-gray-400">${formatFileSize(photoData.size)}</div>
        `;

        previewGrid.appendChild(previewDiv);
    }

    function removePhoto(photoId) {
        // Remove from uploadedPhotos array
        uploadedPhotos = uploadedPhotos.filter(function(photo) {
            return photo.id !== photoId;
        });

        // Remove from preview grid
        var previewDiv = document.querySelector('[data-photo-id="' + photoId + '"]');
        if (previewDiv) {
            previewDiv.remove();
        }

        // Hide grid if no photos
        var previewGrid = document.getElementById('photo-preview-grid');
        if (uploadedPhotos.length === 0) {
            previewGrid.style.display = 'none';
        }
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        var k = 1024;
        var sizes = ['Bytes', 'KB', 'MB', 'GB'];
        var i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // New evaluation functions for program-based selection
    function populateObjectivesForProgram() {
        var programSelect = document.getElementById('evaluation-program');
        var objectiveSelect = document.getElementById('evaluation-objective');
        var selectedProgram = programSelect.value;

        // Clear objective dropdown
        objectiveSelect.innerHTML = '<option value="">Select an objective</option>';

        // Hide sections
        document.getElementById('objective-details').style.display = 'none';
        document.getElementById('students-evaluation-section').style.display = 'none';

        if (!selectedProgram) return;

        // Find objectives for the selected program
        var programObjectives = currentData.filter(function(item) {
            return item.type === 'objectives' && item.program === selectedProgram;
        });

        if (programObjectives.length === 0) {
            objectiveSelect.innerHTML = '<option value="">No objectives found for this program</option>';
            return;
        }

        // Populate objective dropdown
        for (var i = 0; i < programObjectives.length; i++) {
            var obj = programObjectives[i];
            var monthDate = new Date(obj.month + '-01');
            var monthName = monthDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
            var subjectName = getSubjectName(obj.subject);
            var optionText = monthName + ' - ' + subjectName;

            var option = document.createElement('option');
            option.value = obj.id;
            option.textContent = optionText;
            objectiveSelect.appendChild(option);
        }
    }

    function showObjectiveDetails() {
        var objectiveSelect = document.getElementById('evaluation-objective');
        var selectedObjectiveId = objectiveSelect.value;
        var detailsDiv = document.getElementById('objective-details');
        var detailsContent = document.getElementById('objective-details-content');
        var studentsSection = document.getElementById('students-evaluation-section');

        if (!selectedObjectiveId) {
            detailsDiv.style.display = 'none';
            studentsSection.style.display = 'none';
            return;
        }

        // Find the selected objective
        var selectedObjective = currentData.find(function(item) {
            return item.id === selectedObjectiveId;
        });

        if (!selectedObjective) return;

        // Show objective details
        var subjectName = getSubjectName(selectedObjective.subject);
        detailsContent.innerHTML = `
            <div class="space-y-2 text-sm">
                <div><strong>Subject:</strong> ${subjectName}</div>
                <div><strong>Goal:</strong> ${selectedObjective.goal}</div>
                <div><strong>Success Criteria:</strong> ${selectedObjective.criteria}</div>
                ${selectedObjective.activities ? '<div><strong>Activities:</strong> ' + selectedObjective.activities + '</div>' : ''}
            </div>
        `;
        detailsDiv.style.display = 'block';

        // Populate students for this program
        populateStudentsForEvaluation(selectedObjective.program);
        studentsSection.style.display = 'block';
    }

    function populateStudentsForEvaluation(program) {
        var studentsInProgram = currentData.filter(function(item) {
            return item.type === 'enrollment' && item.student_program === program;
        });

        var checklistDiv = document.getElementById('students-checklist');
        var totalStudentsSpan = document.getElementById('total-students');

        totalStudentsSpan.textContent = studentsInProgram.length;

        if (studentsInProgram.length === 0) {
            checklistDiv.innerHTML = '<div class="text-center text-gray-500 py-4">No students enrolled in this program</div>';
            return;
        }

        var html = '';
        for (var i = 0; i < studentsInProgram.length; i++) {
            var student = studentsInProgram[i];
            var studentName = student.student_first_name + ' ' + student.student_last_name;
            var age = calculateAge(student.student_dob);

            html += `
                <div class="flex items-center p-3 bg-white rounded-lg border hover:bg-gray-50">
                    <input type="checkbox" id="student-${student.id}" name="evaluated-students" value="${studentName}"
                           class="mr-3 h-4 w-4 text-orange-600 focus:ring-orange-500 border-gray-300 rounded"
                           onchange="updateSelectedCount()">
                    <label for="student-${student.id}" class="flex-1 cursor-pointer">
                        <div class="font-medium text-gray-900">${studentName}</div>
                        <div class="text-sm text-gray-500">Age: ${age} years</div>
                    </label>
                </div>
            `;
        }

        checklistDiv.innerHTML = html;
        updateSelectedCount();
    }

    function selectAllStudents() {
        var checkboxes = document.querySelectorAll('input[name="evaluated-students"]');
        for (var i = 0; i < checkboxes.length; i++) {
            checkboxes[i].checked = true;
        }
        updateSelectedCount();
    }

    function clearAllStudents() {
        var checkboxes = document.querySelectorAll('input[name="evaluated-students"]');
        for (var i = 0; i < checkboxes.length; i++) {
            checkboxes[i].checked = false;
        }
        updateSelectedCount();
    }

    function updateSelectedCount() {
        var checkboxes = document.querySelectorAll('input[name="evaluated-students"]:checked');
        var selectedCountSpan = document.getElementById('selected-count');
        selectedCountSpan.textContent = checkboxes.length;
    }

    // Attendance student selection functions
    function showAttendanceStudentList() {
        var studentList = document.getElementById('attendance-student-list');
        populateAttendanceStudents();
        studentList.style.display = 'block';
    }

    function hideAttendanceStudentList() {
        setTimeout(function() {
            var studentList = document.getElementById('attendance-student-list');
            studentList.style.display = 'none';
        }, 200); // Delay to allow click events to register
    }

    // Visit student selection functions
    function showVisitStudentList() {
        var studentList = document.getElementById('visit-student-list');
        populateVisitStudents();
        studentList.style.display = 'block';
    }

    function hideVisitStudentList() {
        setTimeout(function() {
            var studentList = document.getElementById('visit-student-list');
            studentList.style.display = 'none';
        }, 200); // Delay to allow click events to register
    }

    function populateVisitStudents() {
        var enrolledStudents = currentData.filter(function(item) {
            return item.type === 'enrollment';
        });

        var optionsContainer = document.getElementById('visit-student-options');

        if (enrolledStudents.length === 0) {
            optionsContainer.innerHTML = '<div class="p-3 text-gray-500 text-center">No students enrolled yet</div>';
            return;
        }

        // Sort students by name
        enrolledStudents.sort(function(a, b) {
            var nameA = (a.student.student_first_name + ' ' + a.student.student_last_name).toLowerCase();
            var nameB = (b.student.student_first_name + ' ' + b.student.student_last_name).toLowerCase();
            return nameA.localeCompare(nameB);
        });

        var html = '';
        for (var i = 0; i < enrolledStudents.length; i++) {
            var student = enrolledStudents[i].student;
            var studentName = student.student_first_name + ' ' + student.student_last_name;
            var age = calculateAge(student.student_dob);
            var program = programs.find(function(p) { return p.id === enrolledStudents[i].student_program; });
            var programName = program ? program.name : 'Unknown Program';
            var studentId = student.student_id;
            html += '<div class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0" ';
            html += 'onclick="selectVisitStudent(\'' + studentId + '\', \'' + studentName + '\', \'' + age + '\', \'' + programName + '\')">';
            html += '<div class="font-medium text-gray-900">' + studentName + '</div>';
            html += '<div class="text-sm text-gray-600">Age: ' + age + ' years ‚Ä¢ ' + programName + '</div>';
            html += '</div>';
        }

        optionsContainer.innerHTML = html;
    }

    function filterVisitStudents() {
        var searchTerm = document.getElementById('visit-student-search').value.toLowerCase();
        var enrolledStudents = currentData.filter(function(item) {
            return item.type === 'enrollment';
        });

        if (searchTerm === '') {
            populateVisitStudents();
            return;
        }

        var filteredStudents = enrolledStudents.filter(function(estudent) {
            var studentName = (estudent.student.student_first_name + ' ' + estudent.student.student_last_name).toLowerCase();
            var program = programs.find(function(p) { return p.id === estudent.student_program; });
            var programName = program ? program.name.toLowerCase() : '';

            return studentName.includes(searchTerm) || programName.includes(searchTerm);
        });

        var optionsContainer = document.getElementById('visit-student-options');

        if (filteredStudents.length === 0) {
            optionsContainer.innerHTML = '<div class="p-3 text-gray-500 text-center">No students found matching "' + searchTerm + '"</div>';
            return;
        }

        // Sort filtered results
        filteredStudents.sort(function(a, b) {
            var nameA = (a.student.student_first_name + ' ' + a.student.student_last_name).toLowerCase();
            var nameB = (b.student.student_first_name + ' ' + b.student.student_last_name).toLowerCase();
            return nameA.localeCompare(nameB);
        });

        var html = '';
        for (var i = 0; i < filteredStudents.length; i++) {
            var student = filteredStudents[i].student;
            var studentName = student.student_first_name + ' ' + student.student_last_name;
            var age = calculateAge(student.student_dob);
            var program = programs.find(function(p) { return p.id === filteredStudents[i].student_program; });
            var programName = program ? program.name : 'Unknown Program';
             var studentId = student.student_id;
            html += '<div class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0" ';
            html += 'onclick="selectVisitStudent(\'' + studentId + '\', \'' + studentName + '\', \'' + age + '\', \'' + programName + '\')">';
            html += '<div class="font-medium text-gray-900">' + studentName + '</div>';
            html += '<div class="text-sm text-gray-600">Age: ' + age + ' years ‚Ä¢ ' + programName + '</div>';
            html += '</div>';
        }

        optionsContainer.innerHTML = html;
    }

    function selectVisitStudent(studentId, studentName, age, programName) {
        // Set the selected student
        document.getElementById('visit-student').value = studentName;
        document.getElementById('visit-student-search').value = studentName;

        // Show student info
        var infoDiv = document.getElementById('selected-visit-student-info');
        infoDiv.innerHTML = '<strong>Selected:</strong> ' + studentName + ' (Age: ' + age + ', Program: ' + programName + ')';
        infoDiv.style.display = 'block';

        // Hide the dropdown
        document.getElementById('visit-student-list').style.display = 'none';

        // Populate parent/guardian options
        populateParentOptions(studentId);

        // Show parent selection section
        document.getElementById('parent-selection-section').style.display = 'block';
    }

    function populateParentOptions(studentId) {
        var student = currentData.find(function(item) {
            return item.id === studentId && item.type === 'enrollment';
        });

        if (!student) return;

        var parentSelect = document.getElementById('visit-parent-attended');
        parentSelect.innerHTML = '<option value="">Select who was met</option>';

        // Check if we have multiple parents data
        if (student.parents_data) {
            try {
                var parentsData = JSON.parse(student.parents_data);
                for (var i = 0; i < parentsData.length; i++) {
                    var parent = parentsData[i];
                    var option = document.createElement('option');
                    option.value = parent.name + ' (' + parent.relationship + ')';
                    option.textContent = parent.name + ' (' + parent.relationship + ')';
                    if (parent.is_primary) {
                        option.textContent += ' - Primary Contact';
                    }
                    parentSelect.appendChild(option);
                }
            } catch (e) {
                // Fallback to old format
                var option = document.createElement('option');
                option.value = student.parent_name + ' (' + student.parent_relationship + ')';
                option.textContent = student.parent_name + ' (' + student.parent_relationship + ')';
                parentSelect.appendChild(option);
            }
        } else {
            // Fallback to old format
            var option = document.createElement('option');
            option.value = student.parent_name + ' (' + student.parent_relationship + ')';
            option.textContent = student.parent_name + ' (' + student.parent_relationship + ')';
            parentSelect.appendChild(option);
        }

        // Add "Other" option
        var otherOption = document.createElement('option');
        otherOption.value = 'other';
        otherOption.textContent = 'Other';
        parentSelect.appendChild(otherOption);
    }

    function toggleOtherParentField() {
        var parentSelect = document.getElementById('visit-parent-attended');
        var otherField = document.getElementById('other-parent-field');
        var otherInput = document.getElementById('visit-other-parent');

        if (parentSelect.value === 'other') {
            otherField.style.display = 'block';
            otherInput.required = true;
        } else {
            otherField.style.display = 'none';
            otherInput.required = false;
            otherInput.value = '';
        }
    }



    // Attendance report functions
    function switchReportTab(type) {
        var studentTab = document.getElementById('student-report-tab');
        var classTab = document.getElementById('class-report-tab');
        var studentSection = document.getElementById('student-report-section');
        var classSection = document.getElementById('class-report-section');

        if (type === 'student') {
            studentTab.className = 'px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600';
            classTab.className = 'px-4 py-2 font-medium text-gray-500 hover:text-gray-700';
            studentSection.style.display = 'block';
            classSection.style.display = 'none';
        } else {
            classTab.className = 'px-4 py-2 font-medium text-blue-600 border-b-2 border-blue-600';
            studentTab.className = 'px-4 py-2 font-medium text-gray-500 hover:text-gray-700';
            classSection.style.display = 'block';
            studentSection.style.display = 'none';
        }
    }

    function populateReportStudents() {
        var select = document.getElementById('report-student-select');
        var students = currentData.filter(function(item) {
            return item.type === 'enrollment';
        });

        select.innerHTML = '<option value="">Choose a student</option>';

        for (var i = 0; i < students.length; i++) {
            var student = students[i];
            var option = document.createElement('option');
            option.value = student.student_first_name + ' ' + student.student_last_name;
            option.textContent = student.student_first_name + ' ' + student.student_last_name;
            select.appendChild(option);
        }
    }

    function generateStudentReport() {
        var studentName = document.getElementById('report-student-select').value;
        var fromDate = document.getElementById('student-from-date').value;
        var toDate = document.getElementById('student-to-date').value;
        var container = document.getElementById('student-report-content');

        if (!studentName) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">Select a student to view attendance report</div>';
            return;
        }

        // Filter attendance records for the selected student
        var attendanceRecords = currentData.filter(function(item) {
            if (item.type !== 'attendance' || item.student_name !== studentName) {
                return false;
            }

            var recordDate = new Date(item.date);
            var from = fromDate ? new Date(fromDate) : null;
            var to = toDate ? new Date(toDate) : null;

            if (from && recordDate < from) return false;
            if (to && recordDate > to) return false;

            return true;
        });

        if (attendanceRecords.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">No attendance records found for the selected criteria</div>';
            return;
        }

        // Sort by date (newest first)
        attendanceRecords.sort(function(a, b) {
            return new Date(b.date) - new Date(a.date);
        });

        // Calculate statistics
        var totalDays = attendanceRecords.length;
        var presentDays = attendanceRecords.filter(function(r) { return r.status === 'present'; }).length;
        var lateDays = attendanceRecords.filter(function(r) { return r.status === 'late'; }).length;
        var absentDays = attendanceRecords.filter(function(r) { return r.status === 'absent'; }).length;
        var attendanceRate = Math.round(((presentDays + lateDays) / totalDays) * 100);

        var html = '<div class="space-y-6">';

        // Summary Statistics
        html += '<div class="bg-blue-50 rounded-lg p-4">';
        html += '<h4 class="text-lg font-semibold text-blue-900 mb-3">Attendance Summary for ' + studentName + '</h4>';
        html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">';
        html += '<div class="bg-white rounded-lg p-3">';
        html += '<div class="text-2xl font-bold text-blue-600">' + totalDays + '</div>';
        html += '<div class="text-sm text-gray-600">Total Days</div>';
        html += '</div>';
        html += '<div class="bg-white rounded-lg p-3">';
        html += '<div class="text-2xl font-bold text-green-600">' + presentDays + '</div>';
        html += '<div class="text-sm text-gray-600">Present</div>';
        html += '</div>';
        html += '<div class="bg-white rounded-lg p-3">';
        html += '<div class="text-2xl font-bold text-orange-600">' + lateDays + '</div>';
        html += '<div class="text-sm text-gray-600">Late</div>';
        html += '</div>';
        html += '<div class="bg-white rounded-lg p-3">';
        html += '<div class="text-2xl font-bold text-red-600">' + absentDays + '</div>';
        html += '<div class="text-sm text-gray-600">Absent</div>';
        html += '</div>';
        html += '</div>';
        html += '<div class="mt-4 text-center">';
        html += '<span class="text-lg font-semibold">Attendance Rate: </span>';
        html += '<span class="text-xl font-bold text-' + (attendanceRate >= 90 ? 'green' : attendanceRate >= 75 ? 'orange' : 'red') + '-600">' + attendanceRate + '%</span>';
        html += '</div>';
        html += '</div>';

        // Detailed Records
        html += '<div class="bg-white border rounded-lg">';
        html += '<div class="px-4 py-3 border-b bg-gray-50">';
        html += '<h5 class="font-semibold text-gray-900">Detailed Attendance Records</h5>';
        html += '</div>';
        html += '<div class="divide-y divide-gray-200">';

        for (var i = 0; i < attendanceRecords.length; i++) {
            var record = attendanceRecords[i];
            var date = new Date(record.date).toLocaleDateString();
            var statusColor = record.status === 'present' ? 'green' :
                            record.status === 'late' ? 'orange' : 'red';
            var statusIcon = record.status === 'present' ? '‚úÖ' :
                           record.status === 'late' ? '‚è∞' : '‚ùå';

            html += '<div class="px-4 py-3 flex justify-between items-center">';
            html += '<div class="flex items-center">';
            html += '<span class="mr-3">' + statusIcon + '</span>';
            html += '<div>';
            html += '<div class="font-medium">' + date + '</div>';
            if (record.time_in || record.time_out) {
                html += '<div class="text-sm text-gray-500">';
                if (record.time_in) html += 'In: ' + record.time_in;
                if (record.time_out) html += ' | Out: ' + record.time_out;
                html += '</div>';
            }
            html += '</div>';
            html += '</div>';
            html += '<span class="px-2 py-1 text-xs font-medium bg-' + statusColor + '-100 text-' + statusColor + '-800 rounded-full">';
            html += record.status.charAt(0).toUpperCase() + record.status.slice(1);
            html += '</span>';
            html += '</div>';
        }

        html += '</div>';
        html += '</div>';
        html += '</div>';

        container.innerHTML = html;
    }

    function generateClassReport() {
        var program = document.getElementById('report-program-select').value;
        var fromDate = document.getElementById('class-from-date').value;
        var toDate = document.getElementById('class-to-date').value;
        var container = document.getElementById('class-report-content');

        if (!program) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">Select a program to view class attendance report</div>';
            return;
        }

        // Get students in the selected program
        var studentsInProgram = currentData.filter(function(item) {
            return item.type === 'enrollment' && item.student_program === program;
        });

        if (studentsInProgram.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">No students enrolled in the selected program</div>';
            return;
        }

        // Get attendance records for students in this program within date range
        var attendanceRecords = currentData.filter(function(item) {
            if (item.type !== 'attendance') return false;

            var recordDate = new Date(item.date);
            var from = fromDate ? new Date(fromDate) : null;
            var to = toDate ? new Date(toDate) : null;

            if (from && recordDate < from) return false;
            if (to && recordDate > to) return false;

            // Check if student is in the selected program
            var student = studentsInProgram.find(function(s) {
                return (s.student_first_name + ' ' + s.student_last_name) === item.student_name;
            });

            return !!student;
        });

        // Group attendance by student
        var attendanceByStudent = {};
        for (var i = 0; i < studentsInProgram.length; i++) {
            var student = studentsInProgram[i];
            var studentName = student.student_first_name + ' ' + student.student_last_name;
            attendanceByStudent[studentName] = {
                student: student,
                records: attendanceRecords.filter(function(r) { return r.student_name === studentName; })
            };
        }

        var programName = getProgramName(program);
        var html = '<div class="space-y-6">';

        // Class Summary
        var totalStudents = studentsInProgram.length;
        var studentsWithRecords = Object.keys(attendanceByStudent).filter(function(name) {
            return attendanceByStudent[name].records.length > 0;
        }).length;

        html += '<div class="bg-green-50 rounded-lg p-4">';
        html += '<h4 class="text-lg font-semibold text-green-900 mb-3">Class Attendance Summary - ' + programName + '</h4>';
        html += '<div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center">';
        html += '<div class="bg-white rounded-lg p-3">';
        html += '<div class="text-2xl font-bold text-blue-600">' + totalStudents + '</div>';
        html += '<div class="text-sm text-gray-600">Total Students</div>';
        html += '</div>';
        html += '<div class="bg-white rounded-lg p-3">';
        html += '<div class="text-2xl font-bold text-green-600">' + studentsWithRecords + '</div>';
        html += '<div class="text-sm text-gray-600">With Records</div>';
        html += '</div>';
        html += '<div class="bg-white rounded-lg p-3">';
        html += '<div class="text-2xl font-bold text-gray-600">' + (totalStudents - studentsWithRecords) + '</div>';
        html += '<div class="text-sm text-gray-600">No Records</div>';
        html += '</div>';
        html += '</div>';
        html += '</div>';

        // Individual Student Reports
        html += '<div class="bg-white border rounded-lg">';
        html += '<div class="px-4 py-3 border-b bg-gray-50">';
        html += '<h5 class="font-semibold text-gray-900">Individual Student Attendance</h5>';
        html += '</div>';
        html += '<div class="divide-y divide-gray-200">';

        var studentNames = Object.keys(attendanceByStudent).sort();
        for (var j = 0; j < studentNames.length; j++) {
            var studentName = studentNames[j];
            var studentData = attendanceByStudent[studentName];
            var records = studentData.records;

            var totalDays = records.length;
            var presentDays = records.filter(function(r) { return r.status === 'present'; }).length;
            var lateDays = records.filter(function(r) { return r.status === 'late'; }).length;
            var absentDays = records.filter(function(r) { return r.status === 'absent'; }).length;
            var attendanceRate = totalDays > 0 ? Math.round(((presentDays + lateDays) / totalDays) * 100) : 0;

            html += '<div class="px-4 py-4">';
            html += '<div class="flex justify-between items-start mb-2">';
            html += '<div>';
            html += '<h6 class="font-medium text-gray-900">' + studentName + '</h6>';
            if (totalDays > 0) {
                html += '<div class="text-sm text-gray-600">Total Days: ' + totalDays + ' | Attendance Rate: ';
                html += '<span class="font-medium text-' + (attendanceRate >= 90 ? 'green' : attendanceRate >= 75 ? 'orange' : 'red') + '-600">' + attendanceRate + '%</span>';
                html += '</div>';
            } else {
                html += '<div class="text-sm text-gray-500">No attendance records</div>';
            }
            html += '</div>';
            html += '</div>';

            if (totalDays > 0) {
                html += '<div class="grid grid-cols-3 gap-2 text-center text-sm">';
                html += '<div class="bg-green-50 rounded p-2">';
                html += '<div class="font-medium text-green-600">' + presentDays + '</div>';
                html += '<div class="text-gray-600">Present</div>';
                html += '</div>';
                html += '<div class="bg-orange-50 rounded p-2">';
                html += '<div class="font-medium text-orange-600">' + lateDays + '</div>';
                html += '<div class="text-gray-600">Late</div>';
                html += '</div>';
                html += '<div class="bg-red-50 rounded p-2">';
                html += '<div class="font-medium text-red-600">' + absentDays + '</div>';
                html += '<div class="text-gray-600">Absent</div>';
                html += '</div>';
                html += '</div>';
            }

            html += '</div>';
        }

        html += '</div>';
        html += '</div>';
        html += '</div>';

        container.innerHTML = html;
    }

    // Parent field management functions
   /* function addParentField() {
        parentFieldCounter++;
        var container = document.getElementById('parents-container');
        var parentCount = container.children.length + 1;

        var parentEntry = document.createElement('div');
        parentEntry.className = 'parent-entry bg-gray-50 rounded-lg p-4 mb-4';
        parentEntry.setAttribute('data-parent-index', parentFieldCounter);

        parentEntry.innerHTML = `
            <div class="flex justify-between items-center mb-3">
                <h5 class="font-medium text-gray-700">Parent/Guardian ${parentCount}</h5>
                <button type="button" onclick="removeParentField(${parentFieldCounter})" class="text-red-600 hover:text-red-800 text-sm">
                    Remove
                </button>
            </div>
            <div class="grid md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                    <input type="text" name="parent-name-${parentFieldCounter}" class="w-full p-3 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Relationship</label>
                    <select name="parent-relationship-${parentFieldCounter}" class="w-full p-3 border border-gray-300 rounded-lg" required onchange="handleRelationshipChange(${parentFieldCounter})">
                        <option value="">Select relationship</option>
                        <option value="mother">Mother</option>
                        <option value="father">Father</option>
                        <option value="guardian">Guardian</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contact Number</label>
                    <input type="tel" name="parent-contact-${parentFieldCounter}" class="w-full p-3 border border-gray-300 rounded-lg" required>
                </div>
            </div>

            <div class="mt-3">
                <label class="block text-sm font-medium text-gray-700 mb-2">Address (if different from student)</label>
                <textarea name="parent-address-${parentFieldCounter}" class="w-full p-3 border border-gray-300 rounded-lg" rows="2" placeholder="Leave blank if same as student address"></textarea>
            </div>

            <div class="mt-3" id="aadhaar-field-${parentFieldCounter}" style="display: none;">
                <label class="block text-sm font-medium text-gray-700 mb-2">Aadhaar Number (Required for Mother) <span class="text-red-500">*</span></label>
                <input type="text" name="parent-aadhaar-${parentFieldCounter}" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Enter 12-digit Aadhaar number" pattern="[0-9]{12}" maxlength="12">
                <p class="text-xs text-gray-500 mt-1">Required field for mothers. Enter 12 digits without spaces.</p>
            </div>

            <div class="mt-3">
                <label class="flex items-center">
                    <input type="checkbox" name="parent-primary-${parentFieldCounter}" class="mr-2" onchange="setPrimaryContact(${parentFieldCounter})">
                    <span class="text-sm text-gray-700">Primary contact for emergencies</span>
                </label>
            </div>
        `;

        container.appendChild(parentEntry);
        updateRemoveButtons();
        updateRelationshipOptions();
    }

    function removeParentField(index) {
        var entry = document.querySelector('[data-parent-index="' + index + '"]');
        if (entry) {
            entry.remove();
            updateParentLabels();
            updateRemoveButtons();
            updateRelationshipOptions();
        }
    }
*/
  /*  function updateRemoveButtons() {
        var entries = document.querySelectorAll('.parent-entry');
        for (var i = 0; i < entries.length; i++) {
            var removeBtn = entries[i].querySelector('button[onclick*="removeParentField"]');
            if (removeBtn) {
                removeBtn.style.display = entries.length > 1 ? 'block' : 'none';
            }
        }
    }
*/
  /*  function updateParentLabels() {
        var entries = document.querySelectorAll('.parent-entry');
        for (var i = 0; i < entries.length; i++) {
            var label = entries[i].querySelector('h5');
            if (label) {
                label.textContent = 'Parent/Guardian ' + (i + 1);
            }
        }
    }
*/
  /*  function setPrimaryContact(selectedIndex) {
        // Uncheck all other primary contact checkboxes
        var allPrimaryCheckboxes = document.querySelectorAll('[name*="parent-primary-"]');
        for (var i = 0; i < allPrimaryCheckboxes.length; i++) {
            var checkbox = allPrimaryCheckboxes[i];
            if (checkbox.name !== 'parent-primary-' + selectedIndex) {
                checkbox.checked = false;
            }
        }
    }
*/
    // Modal functions
    function openModal(type) {
        if (type === 'student-list') {
            document.getElementById('student-search').value = '';
            renderStudentList();
        } else if (type === 'program-list') {
            renderProgramList();
        } else if (type === 'objectives-list') {
            renderObjectivesList();
        } else if (type === 'evaluations') {
            // Reset form state
          //  document.getElementById('evaluation-program').value = '';
          //  document.getElementById('evaluation-objective').innerHTML = '<option value="">Select program first</option>';
          //  document.getElementById('objective-details').style.display = 'none';
          //  document.getElementById('students-evaluation-section').style.display = 'none';
            // Set today's date as default
          //  document.getElementById('evaluation-date').value = new Date().toISOString().split('T')[0];
          document.getElementById('evaluations-modal').classList.remove('hidden');
                populateProgramSelect();
                renderStudentList();
        } else if (type === 'enrollment') {
            // Set today's date as default for date of joining
            document.getElementById('student-doj').value = new Date().toISOString().split('T')[0];

        } else if (type === 'attendance') {
        // Reset attendance form
           // console.log(document.getElementById('attendanceModal').classList.contains('hidden'));
           document.getElementById('attendanceModal').classList.remove('hidden');
           populateAttendanceStudents();
           updateLiveTime();
           attendanceCurrentTimerID=setInterval(updateLiveTime, 1000);
        }
        else if (type === 'plan'){
         document.getElementById('plan-date').valueAsDate = new Date();
        document.getElementById('plan-modal').classList.remove('hidden');

        } else if (type === 'visits') {
            // Reset visit form
            document.getElementById('visit-student-search').value = '';
            document.getElementById('visit-student').value = '';
            document.getElementById('selected-visit-student-info').style.display = 'none';
            document.getElementById('visit-student-list').style.display = 'none';
            document.getElementById('parent-selection-section').style.display = 'none';
            document.getElementById('other-parent-field').style.display = 'none';
            }
       else if (type === 'review'){
       document.getElementById('review-date').valueAsDate = new Date();
        document.getElementById('review-modal').classList.remove('hidden');


        } else if (type === 'attendance-reports') {
            populateReportStudents();
            // Set default date range (last 30 days)
            var today = new Date();
            var thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            document.getElementById('student-from-date').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('student-to-date').value = today.toISOString().split('T')[0];
            document.getElementById('class-from-date').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('class-to-date').value = today.toISOString().split('T')[0];
            // Reset to student report tab
            switchReportTab('student');
        }
        document.getElementById(`${type}-modal`).classList.add('show');
    }

    function closeModal(type) {

        document.getElementById(`${type}-modal`).classList.remove('show');
       // if(type == 'plan')
        document.getElementById(`${type}-modal`).classList.add('hidden');
        // Reset form if it exists
        const form = document.getElementById(`${type}-form`);
        if (form) {
            form.reset();

            // Special handling for enrollment form - reset to single parent
            if (type === 'enrollment') {
                resetEnrollmentForm();
            }

            // Special handling for activities form - clear photos
            if (type === 'activities') {
                uploadedPhotos = [];
                document.getElementById('photo-preview-grid').style.display = 'none';
                document.getElementById('photo-preview-grid').innerHTML = '';
                document.getElementById('upload-status').style.display = 'none';
            }
        }
    }

    function resetEnrollmentForm() {
        var container = document.getElementById('parents-container');
        // Remove all parent entries except the first one
        var entries = container.querySelectorAll('.parent-entry');
        for (var i = 1; i < entries.length; i++) {
            entries[i].remove();
        }

        // Reset the first entry
        var firstEntry = container.querySelector('.parent-entry');
        if (firstEntry) {
            firstEntry.setAttribute('data-parent-index', '0');
            firstEntry.querySelector('h5').textContent = 'Parent/Guardian 1';
            var removeBtn = firstEntry.querySelector('button[onclick*="removeParentField"]');
            if (removeBtn) {
                removeBtn.style.display = 'none';
                removeBtn.setAttribute('onclick', 'removeParentField(0)');
            }

            // Reset all field names to index 0
            var inputs = firstEntry.querySelectorAll('input, select, textarea');
            for (var j = 0; j < inputs.length; j++) {
                var input = inputs[j];
                var name = input.name;
                if (name && name.includes('parent-')) {
                    var baseName = name.split('-').slice(0, -1).join('-');
                    input.name = baseName + '-0';
                }
                if (input.type === 'checkbox') {
                    input.setAttribute('onchange', 'setPrimaryContact(0)');
                }
                if (input.tagName === 'SELECT' && name && name.includes('relationship')) {
                    input.setAttribute('onchange', 'handleRelationshipChange(0)');
                }
            }
        }

        // Reset counter
        parentFieldCounter = 0;
    }

    // Form submission handlers
    function handleFormSubmission(event, type) {
        event.preventDefault();

        if (recordCount >= 999) {
            showMessage('Maximum limit of 999 records reached. Please delete some records first.', 'error');
            return;
        }

        var form = event.target;
        var submitButton = form.querySelector('button[type="submit"]');

        // Show loading state
        submitButton.disabled = true;
        submitButton.textContent = 'Saving...';
        form.classList.add('loading');

        var data = {
            id: Date.now().toString(),
            type: type,
            date: new Date().toISOString(),
            created_at: new Date().toISOString()
        };

        // Extract form data based on type
        switch(type) {
            case 'enrollment':
                data.title = 'New Student Enrollment';
                data.student_first_name = document.getElementById('student-first-name').value;
                data.student_last_name = document.getElementById('student-last-name').value;
                data.student_dob = document.getElementById('student-dob').value;
                data.student_doj = document.getElementById('student-doj').value;
                data.student_gender = document.getElementById('student-gender').value;
                data.student_social_category = document.getElementById('student-social-category').value;
                data.student_address = document.getElementById('student-address').value;
                data.student_contact = document.getElementById('student-contact').value;
                data.student_program = document.getElementById('student-program').value;
                data.notes = document.getElementById('enrollment-notes').value;
                data.status = 'enrolled';

                // Collect all parent/guardian information
                var parentEntries = document.querySelectorAll('.parent-entry');
                var parentsData = [];
                var primaryContact = null;

                for (var i = 0; i < parentEntries.length; i++) {
                    var entry = parentEntries[i];
                    var index = entry.getAttribute('data-parent-index');
                    var parentData = {
                        name: entry.querySelector('[name="parent-name-' + index + '"]').value,
                        relationship: entry.querySelector('[name="parent-relationship-' + index + '"]').value,
                        contact: entry.querySelector('[name="parent-contact-' + index + '"]').value,
                        address: entry.querySelector('[name="parent-address-' + index + '"]').value,
                        aadhaar: entry.querySelector('[name="parent-aadhaar-' + index + '"]') ? entry.querySelector('[name="parent-aadhaar-' + index + '"]').value : '',
                        is_primary: entry.querySelector('[name="parent-primary-' + index + '"]').checked
                    };

                    if (parentData.is_primary) {
                        primaryContact = parentData;
                    }

                    parentsData.push(parentData);
                }

                // Store parents data as JSON string for compatibility
                data.parents_data = JSON.stringify(parentsData);

                // Keep primary contact info in main fields for backward compatibility
                if (primaryContact) {
                    data.parent_name = primaryContact.name;
                    data.parent_relationship = primaryContact.relationship;
                    data.parent_contact = primaryContact.contact;
                } else if (parentsData.length > 0) {
                    // Use first parent as default if no primary is selected
                    data.parent_name = parentsData[0].name;
                    data.parent_relationship = parentsData[0].relationship;
                    data.parent_contact = parentsData[0].contact;
                }

                data.description = `Enrolled ${data.student_first_name} ${data.student_last_name}`;
                break;
            case 'attendance':
                data.title = 'Attendance Record';
                data.student_name = document.getElementById('attendance-student').value;
                data.status = 'present'; // Always present since we're recording time in/out
                data.date = new Date().toISOString().split('T')[0]; // Today's date

                // Add time tracking
                data.time_in = document.getElementById('attendance-time-in').value;
                data.time_out = document.getElementById('attendance-time-out').value;

                var timeInfo = '';
                if (data.time_in) {
                    timeInfo += 'In: ' + data.time_in;
                }
                if (data.time_out) {
                    timeInfo += (data.time_in ? ', ' : '') + 'Out: ' + data.time_out;
                }

                data.description = data.student_name + ' - ' + (timeInfo ? '(' + timeInfo + ')' : 'Present');

                submitAttendance();
                break;
            case 'journal':
                data.title = 'Daily Journal Entry';
                data.date = document.getElementById('journal-date').value;

                // Goals section
                data.good_habits = document.getElementById('journal-good-habits').value;
                data.rhymes = document.getElementById('journal-rhymes').value;
                data.science_math = document.getElementById('journal-science-math').value;
                data.prescribed_games = document.getElementById('journal-prescribed-games').value;
                data.story_time = document.getElementById('journal-story-time').value;
                data.creative_activities = document.getElementById('journal-creative-activities').value;
                data.activity_book = document.getElementById('journal-activity-book').value;
                data.indoor_game = document.getElementById('journal-indoor-game').value;
                data.outdoor_game = document.getElementById('journal-outdoor-game').value;

                // Tasks section
                data.attendance_done = document.getElementById('journal-attendance-done').value;
                data.kids_after_lunch = document.getElementById('journal-kids-after-lunch').value;
                data.parents_amc = document.getElementById('journal-parents-amc').value;
                data.home_visits = document.getElementById('journal-home-visits').value;
                data.photos_sent = document.getElementById('journal-photos-sent').value;
                data.phone_calls = document.getElementById('journal-phone-calls').value;
                data.shine_sort = document.getElementById('journal-shine-sort').value;
                data.tlm_prepared = document.getElementById('journal-tlm-prepared').value;

                // Celebrations section
                data.student_wins = document.getElementById('journal-student-wins').value;
                data.teaching_wins = document.getElementById('journal-teaching-wins').value;
                data.personal_wins = document.getElementById('journal-personal-wins').value;

                // Challenges section
                data.challenges = document.getElementById('journal-challenges').value;

                // Improvement section
                data.improvements = document.getElementById('journal-improvements').value;

                // Observations section
                data.observations = document.getElementById('journal-observations').value;

                // Create summary for description
                var journalDate = new Date(data.date).toLocaleDateString();
                data.description = 'Journal entry for ' + journalDate;
                break;
            case 'meetings':
                data.title = 'Parent-Teacher Meeting';
                data.student_name = document.getElementById('meeting-student').value;
                data.parent_name = document.getElementById('meeting-parent').value;
                data.date = document.getElementById('meeting-date').value;
                data.notes = document.getElementById('meeting-notes').value;
                data.status = 'scheduled';
                data.description = `Meeting with ${data.parent_name} for ${data.student_name}`;
                break;
            case 'visits':
                data.title = 'Home Visit';
                data.student_name = document.getElementById('visit-student').value;
                data.date = document.getElementById('visit-date').value;
                data.notes = document.getElementById('visit-notes').value;
                data.status = 'scheduled';

                // Get parent/guardian who attended
                var parentAttended = document.getElementById('visit-parent-attended').value;
                if (parentAttended === 'other') {
                    data.parent_attended = document.getElementById('visit-other-parent').value;
                } else {
                    data.parent_attended = parentAttended;
                }

                var attendedInfo = data.parent_attended ? ' with ' + data.parent_attended : '';
                data.description = `Home visit for ${data.student_name}${attendedInfo}`;
                break;
            case 'activities':
                data.title = document.getElementById('activity-title').value;
               // data.student_name = document.getElementById('activity-students').value;
                data.description = document.getElementById('activity-description').value;

                // Add photo data
                if (uploadedPhotos.length > 0) {
                    data.photos = JSON.stringify(uploadedPhotos);
                    data.photo_count = uploadedPhotos.length.toString();
                } else {
                    data.photos = '';
                    data.photo_count = '0';
                }
                break;
            case 'objectives':
                data.title = 'Learning Objective';
                data.month = document.getElementById('objective-month').value;
                data.program = document.getElementById('objective-program').value;
                data.subject = document.getElementById('objective-subject').value;
                data.goal = document.getElementById('objective-goal').value;
                data.criteria = document.getElementById('objective-criteria').value;
                data.activities = document.getElementById('objective-activities').value;
                data.priority = document.getElementById('objective-priority').value;
                data.status = 'active';
                var programName = getProgramName(data.program);
                data.description = `${getSubjectName(data.subject)} objective for ${programName}`;
                break;
            case 'evaluations':
                data.title = 'Objective Evaluation';
                data.objective_id = document.getElementById('evaluation-objective').value;
                data.program = document.getElementById('evaluation-program').value;
                data.date = document.getElementById('evaluation-date').value;
                data.general_notes = document.getElementById('evaluation-general-notes').value;
                data.status = 'completed';

                // Get selected students
                var selectedStudents = [];
                var checkboxes = document.querySelectorAll('input[name="evaluated-students"]:checked');
                for (var cb = 0; cb < checkboxes.length; cb++) {
                    selectedStudents.push(checkboxes[cb].value);
                }

                if (selectedStudents.length === 0) {
                    showMessage('Please select at least one student to evaluate.', 'error');
                    return;
                }

                data.students_met_criteria = selectedStudents.join(', ');
                data.students_evaluated_count = selectedStudents.length.toString();

                // Find the objective being evaluated
                var objective = currentData.find(function(item) {
                    return item.id === data.objective_id;
                });
                if (objective) {
                    data.subject = objective.subject;
                    var subjectName = getSubjectName(objective.subject);
                    var programName = getProgramName(data.program);
                    data.description = `${subjectName} evaluation for ${programName} - ${selectedStudents.length} students assessed`;
                } else {
                    data.description = `Class evaluation - ${selectedStudents.length} students assessed`;
                }
                break;
        }

        window.dataSdk.create(data).then(function(result) {
            if (result.isOk) {
                closeModal(type);
                showMessage('Record saved successfully!', 'success');
            } else {
                showMessage('Failed to save record. Please try again.', 'error');
            }
        }).catch(function(error) {
            showMessage('An error occurred. Please try again.', 'error');
        }).then(function() {
            // Reset loading state - success case
            submitButton.disabled = false;
            submitButton.textContent = getSubmitButtonText(type);
            form.classList.remove('loading');
        }, function() {
            // Reset loading state - error case
            submitButton.disabled = false;
            submitButton.textContent = getSubmitButtonText(type);
            form.classList.remove('loading');
        });
    }

    function getSubmitButtonText(type) {
        const texts = {
            enrollment: 'Enroll Student',
            attendance: 'Mark Attendance',
            journal: 'Save Entry',
            meetings: 'Schedule Meeting',
            visits: 'Save Details',
            activities: 'Log Activity',
            objectives: 'Save Objective',
            evaluations: 'Save Evaluation'
        };
        return texts[type] || 'Submit';
    }

    function showMessage(message, type) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
        }`;
        messageDiv.textContent = message;
        document.body.appendChild(messageDiv);

        setTimeout(() => {
            messageDiv.remove();
        }, 3000);
    }

    // Element SDK configuration
    function onConfigChange(config) {
        var educatorNameEl = document.getElementById('educator-name');
        if (educatorNameEl) {
            educatorNameEl.textContent = config.educator_name || defaultConfig.educator_name;
        }

        var schoolNameEl = document.getElementById('school-name');
        if (schoolNameEl) {
            schoolNameEl.textContent = config.school_name || defaultConfig.school_name;
        }

        var welcomeMessageEl = document.getElementById('welcome-message');
        if (welcomeMessageEl) {
            welcomeMessageEl.textContent = config.welcome_message || defaultConfig.welcome_message;
        }
    }

    function mapToCapabilities(config) {
        return {
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
        };
    }

    function mapToEditPanelValues(config) {
        return new Map([
            ["educator_name", config.educator_name || defaultConfig.educator_name],
            ["school_name", config.school_name || defaultConfig.school_name],
            ["welcome_message", config.welcome_message || defaultConfig.welcome_message]
        ]);
    }

    // Voice input functions
    function initializeVoiceRecognition() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            voiceRecognition = new SpeechRecognition();
            voiceRecognition.continuous = false;
            voiceRecognition.interimResults = false;
            voiceRecognition.lang = 'en-US';

            voiceRecognition.onstart = function() {
                if (currentVoiceTarget) {
                    var button = document.querySelector('[onclick*="' + currentVoiceTarget + '"]');
                    if (button) {
                        button.classList.add('recording');
                        showVoiceStatus(button, 'Listening...');
                    }
                }
            };

            voiceRecognition.onresult = function(event) {
                var transcript = event.results[0][0].transcript;
                if (currentVoiceTarget) {
                    var textarea = document.getElementById(currentVoiceTarget);
                    if (textarea) {
                        // Append to existing text with proper spacing
                        var currentText = textarea.value.trim();
                        if (currentText) {
                            textarea.value = currentText + ' ' + transcript;
                        } else {
                            textarea.value = transcript;
                        }
                        // Trigger input event for any listeners
                        textarea.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
            };

            voiceRecognition.onerror = function(event) {
                if (currentVoiceTarget) {
                    var button = document.querySelector('[onclick*="' + currentVoiceTarget + '"]');
                    if (button) {
                        button.classList.remove('recording', 'processing');
                        showVoiceStatus(button, 'Error: ' + event.error, true);
                    }
                }
                currentVoiceTarget = null;
            };

            voiceRecognition.onend = function() {
                if (currentVoiceTarget) {
                    var button = document.querySelector('[onclick*="' + currentVoiceTarget + '"]');
                    if (button) {
                        button.classList.remove('recording', 'processing');
                        hideVoiceStatus(button);
                    }
                }
                currentVoiceTarget = null;
            };
        }
    }

    function toggleVoiceInput(textareaId) {
        if (!voiceRecognition) {
            showMessage('Voice input is not supported in your browser. Please use Chrome, Edge, or Safari.', 'error');
            return;
        }

        var button = document.querySelector('[onclick*="' + textareaId + '"]');

        if (currentVoiceTarget === textareaId && voiceRecognition.recording) {
            // Stop recording
            voiceRecognition.stop();
            return;
        }

        if (currentVoiceTarget && currentVoiceTarget !== textareaId) {
            // Stop any existing recording
            voiceRecognition.stop();
        }

        currentVoiceTarget = textareaId;

        try {
            button.classList.add('processing');
            showVoiceStatus(button, 'Starting...');
            voiceRecognition.start();
        } catch (error) {
            button.classList.remove('processing');
            hideVoiceStatus(button);
            showMessage('Voice input failed to start. Please try again.', 'error');
            currentVoiceTarget = null;
        }
    }

    function showVoiceStatus(button, message, isError) {
        hideVoiceStatus(button); // Remove any existing status

        var status = document.createElement('div');
        status.className = 'voice-status';
        status.textContent = message;
        if (isError) {
            status.style.background = '#ef4444';
        }

        var container = button.parentElement;
        container.appendChild(status);

        if (isError) {
            setTimeout(function() {
                hideVoiceStatus(button);
            }, 3000);
        }
    }

    function hideVoiceStatus(button) {
        var container = button.parentElement;
        var existingStatus = container.querySelector('.voice-status');
        if (existingStatus) {
            existingStatus.remove();
        }
    }

    // Initialize everything
    document.addEventListener('DOMContentLoaded', function() {
        updateTime();
        setInterval(updateTime, 60000); // Update every minute

        // Initialize voice recognition
        initializeVoiceRecognition();

        // Initialize SDKs
        initializeDataSDK();

        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig,
                onConfigChange,
                mapToCapabilities,
                mapToEditPanelValues
            });
        }

        // Add form event listeners
        document.getElementById('enrollment-form').addEventListener('submit', function(e) {
            // Validate mother's Aadhaar before submission
            var parentEntries = document.querySelectorAll('.parent-entry');
            var hasMotherWithoutAadhaar = false;

            for (var i = 0; i < parentEntries.length; i++) {
                var entry = parentEntries[i];
                var index = entry.getAttribute('data-parent-index');
                var relationshipSelect = entry.querySelector('[name="parent-relationship-' + index + '"]');
                var aadhaarInput = entry.querySelector('[name="parent-aadhaar-' + index + '"]');

                if (relationshipSelect && relationshipSelect.value === 'mother') {
                    if (!aadhaarInput || !aadhaarInput.value.trim()) {
                        hasMotherWithoutAadhaar = true;
                        break;
                    }

                    // Validate Aadhaar format (12 digits)
                    var aadhaarValue = aadhaarInput.value.trim();
                    if (!/^\d{12}$/.test(aadhaarValue)) {
                        e.preventDefault();
                        showMessage('Mother\'s Aadhaar number must be exactly 12 digits.', 'error');
                        aadhaarInput.focus();
                        return;
                    }
                }
            }

            if (hasMotherWithoutAadhaar) {
                e.preventDefault();
                showMessage('Mother\'s Aadhaar number is required and cannot be empty.', 'error');
                return;
            }

            handleFormSubmission(e, 'enrollment');
        });
        /*document.getElementById('attendance-form').addEventListener('submit', function(e) {
            handleFormSubmission(e, 'attendance');
        });*/
      /*  document.getElementById('journal-form').addEventListener('submit', function(e) {
            handleFormSubmission(e, 'journal');
        });*/
        document.getElementById('meetings-form').addEventListener('submit', function(e) {
            handleFormSubmission(e, 'meetings');
        });
        document.getElementById('visits-form').addEventListener('submit', function(e) {
            handleFormSubmission(e, 'visits');
        });
        document.getElementById('activities-form').addEventListener('submit', function(e) {
            handleFormSubmission(e, 'activities');
        });
        document.getElementById('objectives-form').addEventListener('submit', function(e) {
            handleFormSubmission(e, 'objectives');
        });
       /* document.getElementById('evaluations-form').addEventListener('submit', function(e) {
            handleFormSubmission(e, 'evaluations');
        });*/

        // Close modals when clicking outside
        var modals = document.querySelectorAll('.modal');
        for (var i = 0; i < modals.length; i++) {
            modals[i].addEventListener('click', function(e) {
                if (e.target === this) {
                    var modalId = this.id.replace('-modal', '');
                    closeModal(modalId);
                }
            });
        }

        // Close attendance student list when clicking outside
        document.addEventListener('click', function(e) {
          /*  var studentList = document.getElementById('attendance-student-list');
            var searchInput = document.getElementById('attendance-student-search');

            if (studentList && searchInput &&
                !studentList.contains(e.target) &&
                !searchInput.contains(e.target)) {
                studentList.style.display = 'none';
            }
            */

            // Close visit student list when clicking outside
            var visitStudentList = document.getElementById('visit-student-list');
            var visitSearchInput = document.getElementById('visit-student-search');

            if (visitStudentList && visitSearchInput &&
                !visitStudentList.contains(e.target) &&
                !visitSearchInput.contains(e.target)) {
                visitStudentList.style.display = 'none';
            }
        });

        // Handle blur event for search inputs
      /*  document.getElementById('attendance-student-search').addEventListener('blur', function() {
            hideAttendanceStudentList();
        });*/

        document.getElementById('visit-student-search').addEventListener('blur', function() {
            hideVisitStudentList();
        });

        // Add drag and drop support for photo upload
        var uploadArea = document.getElementById('photo-upload-area');
        if (uploadArea) {
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.add('border-indigo-400', 'bg-indigo-50');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('border-indigo-400', 'bg-indigo-50');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('border-indigo-400', 'bg-indigo-50');

                var files = e.dataTransfer.files;
                if (files.length > 0) {
                    // Create a fake event object for handlePhotoUpload
                    var fakeEvent = {
                        target: {
                            files: files,
                            value: ''
                        }
                    };
                    handlePhotoUpload(fakeEvent);
                }
            });
        }
    });

</script>
</html>